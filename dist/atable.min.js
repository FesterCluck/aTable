/*! aTable v0.1.0 - 2013-03-20 */
var Column=Backbone.Model.extend({initialize:function(){},idAttribute:"name"}),Row=Backbone.Model.extend({initialize:function(){},defaults:{row:[]}}),ColumnCollection=Backbone.Collection.extend({initialize:function(){},model:Column,comparator:function(t){return t.get("order")},renameColumn:function(t,e){if(!e)throw"Invalid column name";var i=this.get(t);i&&i.set({name:e})},moveColumn:function(t,e){var i=this.at(t),n=this.at(e);if(!i)throw"Invalid column index: "+t;if(!n)throw"Invalid column index: "+e;var o,s=i.get("order"),r=n.get("order");if(r>s)for(var l=s+1;r>=l;l++)o=this.at(l),o.set({order:o.get("order")-1});else for(var a=s-1;a>=r;a--)o=this.at(a),o.set({order:o.get("order")+1});i.set({order:r}),this.sort()}}),RowCollection=function(){function t(t,e,i){var n=t[e];t[e]=t[i],t[i]=n}return Backbone.Collection.extend({initialize:function(t,e){this.columnOrder=[],e?(this.sortColumn=e.sortColumn,this.sortDescending=null!==e.sortDescending?e.sortDescending:!1):(this.sortColumn=null,this.sortDescending=!1);for(var i=0;e.numColumns>i;i++)this.columnOrder.push(i)},model:Row,getValue:function(t,e){var i=this.at(t).get("row"),n=this.columnOrder[e];return i[n]},getRow:function(t){for(var e=this.at(t).get("row"),i=[],n=0;e.length>n;n++){var o=this.columnOrder[n];i.push(e[o])}return i},getColumnIndex:function(t){return this.columnOrder[t]},moveColumn:function(e,i){if(i>e){this.sortColumn>e&&i>=this.sortColumn?this.sortColumn--:this.sortColumn===e&&(this.sortColumn=i);for(var n=e;i>n;n++)t(this.columnOrder,n,n+1)}else{e>this.sortColumn&&this.sortColumn>=i?this.sortColumn++:this.sortColumn===e&&(this.sortColumn=i);for(var o=e;o>i;o--)t(this.columnOrder,o,o-1)}},setSortColumn:function(t){this.sortColumn===t?this.sortDescending=!this.sortDescending:this.sortColumn=t},comparator:function(t){var e=t.get("row")[this.columnOrder[this.sortColumn]],i=null;if("number"==typeof e)i=e;else if("object"==typeof e)i=e instanceof Date?e.getTime():0;else if("string"==typeof e)return this.sortDescending?(e=e.toLowerCase(),e=e.split(""),e=_.map(e,function(t){return String.fromCharCode(-t.charCodeAt(0))}),e.join("")):e;return this.sortDescending?-i:i}})}(),ATable=function(){function t(t,e,i,n){var o=t.childElementCount-2,s=(e.length-o)*i;if(0>s)t.firstChild.style.height=0,t.lastChild.style.height=0;else{var r=n*i,l=s-r;t.firstChild.style.height=r+"px",t.lastChild.style.height=l+"px"}}function e(){var t=0;$(".resizeIndicator").each(function(){t=parseInt(this.id.split("resize")[1],10)+1});var e=document.createElement("div");return e.className="resizeIndicator",e.id="resize"+t,e}function i(t){var e=t.offsetX,i=!t.target.previousElementSibling,n=$(t.target).closest("th")[0];return e===void 0&&(e=t.originalEvent.pageX-$(t.target).offset().left),!i&&m+1>=e?n.previousElementSibling.cellIndex:m>=t.target.offsetWidth-e?n.cellIndex:-1}function n(t){return null!==t.columns&&0===t.columns.length?"Columns array missing or empty":t.dataFunction?null:"Missing dataFunction arg: actual function or script tag id with fetchData function"}function o(t,e){if(window.Blob&&window.Worker){var i=new Blob([document.querySelector("#"+t).textContent," self.onmessage=function(){"+t+"();};"]),n=window.URL||window.webkitURL,o=new Worker(n.createObjectURL(i));return o.onmessage=function(t){e(t.data.data,t.data.append)},o}throw"Blob and Worker support required to use the web worker interface."}function s(t,e){for(var i=e.columns,n=0;i.length>n;n++)i[n].width===void 0&&(i[n].width=h(i[n].label)+20),i[n].resizable===void 0&&(i[n].resizable=e.resizableColumns),i[n].sortable===void 0&&(i[n].sortable=e.sortable),i[n].label===void 0&&(i[n].label=i[n].name),i[n].visible===void 0&&(i[n].visible=!0),i[n].order=n;return new ColumnCollection(i)}function r(t){for(var e=[],i=0;t.length>i;i++)e.push({row:t.getRow(i)});return e}function l(t){return t?t.offsetWidth-t.clientWidth:0}function a(t,e){var i=document.createElement("div");i.classList.add("sortArrow"),i.innerHTML=e?"&darr;":"&uarr;",t.firstChild.appendChild(i)}function h(t){var e=$("<th>"+t+"</th>").css({position:"absolute","float":"left","white-space":"nowrap",visibility:"hidden"}).appendTo($("body")),i=e.width();return e.remove(),i}function d(t){t.resizableColumns===void 0&&(t.resizableColumns=!0),t.movableColumns===void 0&&(t.movableColumns=!0),t.sortable===void 0&&(t.sortable=!0)}var u=15,c=5,m=7;return Backbone.View.extend({initialize:function(t){_.bindAll(this),"string"==typeof t.dataFunction?this.dataWorker=o(t.dataFunction,this.receivedData):"function"==typeof t.dataFunction&&(this.dataFunction=t.dataFunction),this.reRenderTable=!0,this.dataAppended=!1;var e=n(t);if(e)throw e;if(d(t),this.columns=s(this,t),this.columns.bind("reset",this.render,this),this.columns.bind("sort",this.render,this),this.movableColumns=t.movableColumns,"string"==typeof t.sortColumn){var i=this.columns.indexOf(t.sortColumn);t.sortColumn=i>0?i:0}t.numColumns=this.columns.length,this.rows=new RowCollection([],t),this.rows.init=!1,this.columnTarget=null,this.height=t.height,this.prevScrollTop=0},events:{"click th":"onClickColumnHeader","mousemove th":"onMouseMoveColumnHeader","mouseleave th":"onMouseLeaveColumnHeader","dragstart th":"onStartDragColumnHeader",dragend:"onEndDragColumnHeader","dragenter th div":"onDragEnterColumnHeader","dragover th div":"onDragOverColumnHeader","dragleave th div":"onDragLeaveColumnHeader","drop th div":"onDropColumnHeader"},render:function(t){"function"==typeof t&&(this.renderCallback=t);var e={};if(!this.rows.init)return this.rows.bind("reset",this.render,this),this.rows.bind("sort",this.render,this),this.dataWorker?this.dataWorker.postMessage(null):this.dataFunction(this),this;if(this.reRenderTable){this.reRenderTable=!1,e.columns=this.columns.toJSON(),e.rows=r(this.rows),this.tbodyElt&&(this.prevScrollTop=this.tbodyElt[0].scrollTop),this.generateTableHtml(e);for(var i=this.tableElt.find("th"),n=0;i.length>n;n++)this.columns.at(n).set("element",$(i[n]));if(this.tbodyElt[0].scrollTop=this.prevScrollTop,$("tbody:not(.scrollBound)").addClass("scrollBound").bind("scroll",this.onTableScrolled),this.sizeTable(),"number"==typeof this.rows.sortColumn&&a(this.columns.at(this.rows.sortColumn).get("element")[0],this.rows.sortDescending),"function"==typeof this.renderCallback){var o=this.renderCallback;this.renderCallback=null,o()}}else this.renderRows(this.prevScrollTop,this.tbodyElt[0].scrollTop);return this},renderRows:function(e,i){var n,o,s=this.visibleRows+c;if(e>i)n=this.rowRange.first,o=this.rowRange.prevFirst,this.rowRange.last<=this.rowRange.prevFirst&&(n=this.rowRange.first,o=this.rowRange.last),this.removeRows(o-n,!1),this.addRows(n,o,!0),t(this.tbodyElt[0],this.rows,this.rowHeight,this.rowRange.first);else if(i>e)n=this.rowRange.prevLast,o=this.rowRange.last,this.rowRange.first>=this.rowRange.prevLast&&(n=this.rowRange.first,o=this.rowRange.last),this.removeRows(o-n,!0),this.addRows(n,o,!1),t(this.tbodyElt[0],this.rows,this.rowHeight,this.rowRange.first);else{if(!this.dataAppended)return this.refreshRows(this.rowRange.first),void 0;this.dataAppended=!1,this.rowRange.last<this.rows.length&&s>this.rowRange.last&&(n=this.rowRange.last,o=this.rows.length,o>s&&(o=s),this.addRows(n,o,!1),this.rowRange.last=o),t(this.tbodyElt[0],this.rows,this.rowHeight,this.rowRange.first)}if(this.scrollbarWidth=l(this.tbodyElt[0]),this.scrollbarWidth>0){var r=this.columns.at(this.columns.length-1).get("width");this.tbodyElt.find("td:last-child>div").width(r-this.scrollbarWidth)}this.prevScrollTop=this.tbodyElt[0].scrollTop},addRows:function(t,e,i){for(var n=this.tbodyElt[0].firstChild,o=this.tbodyElt[0].lastChild,s=i?n.nextElementSibling:o,r=t;e>r;r++)this.addRow(r,s)},addRow:function(t,e){for(var i=document.createElement("tr"),n=0;this.columns.length>n;n++){var o=document.createElement("div"),s=this.columns.at(n).get("width");o.style.width=s+"px",o.innerHTML=this.rows.getValue(t,n);var r=document.createElement("td");r.appendChild(o),i.appendChild(r)}this.tbodyElt[0].insertBefore(i,e)},removeRows:function(t,e){var i,n;if(t>this.visibleRows+2*c&&(t=this.visibleRows+2*c),e)i=2,n=t+2;else{var o=this.tbodyElt[0].childElementCount-2;i=o+2-t,n=o+2}for(var s=i;n>s;s++)this.tableElt[0].deleteRow(i)},refreshRows:function(t){var e=this.tbodyElt[0].getElementsByTagName("tr");e.length-2,e=this.tbodyElt[0].getElementsByTagName("tr");for(var i=1;e.length-1>i;i++)for(var n=e[i],o=n.getElementsByTagName("div"),s=0;o.length>s;s++){var r=o[s];r.innerHTML=this.rows.getValue(t+i-1,s)}},sizeTable:function(){for(var t=this.tableElt.find("th"),e=1,i=0;t.length>i;i++)e+=$(t[i])[0].offsetWidth;$.browser.mozilla&&e--,this.tableElt.width(e),this.parentElt.width(e)},doPostRender:function(){$("th").contextMenu({menu:menu},this.initColumnMenu),2>this.columns.length?$("#columnMenu").disableContextMenuItems("#removeColumn"):$("#columnMenu").enableContextMenuItems("#removeColumn")},initColumnMenu:function(t,e,i){this.columnTarget=e.attr("id").split("_")[1],"addColumn"===t?this.showAddColumnDialog(i):"removeColumn"===t?this.removeColumn(this.columnTarget):"renameColumn"===t&&this.showRenameColumnDialog(this.columnTarget,e.text(),i)},showAddColumnDialog:function(t){return new EditColumnDialog({editType:"add",blotterType:this.blotterType,callBack:this.addColumn,columns:this.availableColumnsArray}).show(t),!1},showRenameColumnDialog:function(t,e,i){return new EditColumnDialog({editType:"rename",blotterType:this.blotterType,callBack:this.renameColumn}).show(i,t,e),!1},addColumn:function(t){var e=this.columns.get(this.columnTarget);if(!this.columns.get(t)&&this.availableColumnsHash[t]){for(var i=e.get("order"),n=i;this.columns.length>n;n++){var o=this.columns.at(n);o.set({order:o.get("order")+1},{silent:!0})}var s=h(t)+15;this.columns.add({columnName:t,entityField:t,blotterName:this.blotterType,order:i,width:s}),this.columns.save(this.admin)}},removeColumn:function(t){var e=this.columns.get(t);e.destroy();for(var i=e.get("order");this.columns.length>i;i++){var n=this.columns.at(i);n.set({order:n.get("order")-1})}},renameColumn:function(t,e){this.columns.renameColumn(e,t)},filter:function(){},moveColumn:function(t,e){var i=this.getColumnIndex(t);if(-1===i)throw"Invalid column name: "+t;i!==e&&(this.reRenderTable=!0,this.rows.moveColumn(i,e),this.columns.moveColumn(i,e))},resizeColumn:function(t,e,i){var n=this.getColumnIndex(t);if(-1===n)throw"Invalid column name: "+t;var o=this.columns.at(n);if(!o)throw"Invalid column index: "+n;o.set("width",e),this.reRenderTable=!0,this.render(i)},sort:function(t,e){var i=this.getColumnIndex(t);if(-1===i)throw"Invalid column name: "+t;var n=this.columns.at(i);if(!n)throw"Invalid column index: "+i;this.tableElt.find(".sortArrow").remove(),this.rows.setSortColumn(i),"boolean"==typeof e&&(this.rows.sortDescending=e),a(n.get("element")[0],this.rows.sortDescending),this.rows.sort()},getColumnIndex:function(t){var e;if("number"==typeof t)e=t;else if("string"==typeof t){var i=this.columns.get(t);if(!i)return-1;e=i.get("order")}return e},onTableScrolled:function(t){if(this.prevScrollTop!==t.target.scrollTop){var e=parseInt(t.target.scrollTop/this.rowHeight,10)-c;0>e&&(e=0),this.rowRange.prevFirst=this.rowRange.first,this.rowRange.prevLast=this.rowRange.last,this.rowRange.first=e,this.rowRange.last=e+this.visibleRows+c,this.rowRange.last>this.rows.length&&(this.rowRange.last=this.rows.length,this.rowRange.first=this.rowRange.last-this.visibleRows-c),this.renderRows(this.prevScrollTop,t.target.scrollTop)}},onMouseMoveColumnHeader:function(t){var e=i(t),n=$(t.target).closest("th")[0];n.style.cursor=0>e||!this.columns.at(e).get("resizable")?null:"e-resize"},onMouseLeaveColumnHeader:function(t){var e=$(t.target).closest("th")[0];e.style.cursor=null},onClickColumnHeader:function(t){if(0>i(t)){var e=$(t.target).closest("th")[0];this.columns.at(e.cellIndex).get("sortable")&&this.sort(e.cellIndex)}},onStartDragColumnHeader:function(t){var e=$(t.target),n=i(t);if(n>-1){if(e=this.columns.at(n).get("element"),!this.columns.at(n).get("resizable"))return t.preventDefault&&t.preventDefault(),!1;var o,s,r=e.offset(),l=this.tableElt.parent().offset(),a=this.tableElt.height()+2,h=e.css("padding-left"),d=e.css("padding-right");r.left<l.left?(o=l.left,s=l.left-r.left):(o=r.left,s=0);var u=e.width()-s+Number(h.substring(0,h.length-2))+Number(d.substring(0,d.length-2))-5;$(this.resizeIndicator).css("display","block").css("left",o).css("top",r.top-1).css("height",a).css("width",u).attr("title",e[0].cellIndex),document.addEventListener("dragover",this.onDragResizeIndicator),t.originalEvent.dataTransfer.setDragImage(document.createElement("div"),0,0),t.originalEvent.dataTransfer.setData("text",e[0].cellIndex)}else this.movableColumns?(t.target.style.opacity=.35,t.originalEvent.dataTransfer.setData("text",e[0].cellIndex)):t.preventDefault()},onDragResizeIndicator:function(t){var e=$(this.resizeIndicator).offset(),i=this.rows.getColumnIndex(Number(t.dataTransfer.getData("text"))),n=this.columns.at(i).get("element"),o=t.pageX-e.left,s=h(n.text())+u;o>=s?$(this.resizeIndicator).css("width",o):$(this.resizeIndicator).css("width",s)},onEndDragColumnHeader:function(t){if("none"===$(this.resizeIndicator).css("display"))t.target.style.opacity=null;else{document.removeEventListener("dragover",this.onDragResizeIndicator,!1);var e=$(this.resizeIndicator),i=parseInt(t.originalEvent.clientX-e.position().left-u,10),n=e.width(),o=Number(e.attr("title")),s=this.columns.at(o),r=s.get("element").offset(),l=this.tableElt.parent().offset();r.left<l.left&&(n+=l.left-r.left),i=n>i?n:i,e.css("display","none"),this.resizeColumn(o,i)}},onDragEnterColumnHeader:function(t){var e=t.originalEvent.dataTransfer.getData("text");if(this.movableColumns&&"none"===$(this.resizeIndicator).css("display")){var i=$(t.target).closest("th")[0];i.cellIndex!=e&&i.firstChild.classList.add("over")}},onDragOverColumnHeader:function(t){t.preventDefault&&t.preventDefault()},onDragLeaveColumnHeader:function(t){t.target.classList.remove("over")},onDropColumnHeader:function(t){if(t.preventDefault&&t.preventDefault(),this.movableColumns&&"none"===$(this.resizeIndicator).css("display")){var e=Number(t.originalEvent.dataTransfer.getData("text")),i=t.target.parentElement.cellIndex;"TH"===t.target.tagName?(i=t.target.cellIndex,t.target.firstChild.classList.remove("over")):t.target.classList.remove("over"),this.moveColumn(e,i)}},generateTableHtml:function(t){var i=0;if(this.tbodyElt){var n=this.tbodyElt[0].firstChild.style.height;i=n.substr(0,n.length-2)}for(var o="<tr>",s=0;t.columns.length>s;s++)if(t.columns[s].visible){var r="",a="";t.columns[s].width&&(r='style="width: '+t.columns[s].width+'px;"'),t.columns[s].sortable&&(a=' className="sortable"'),o+='<th draggable="true" '+r+a+"><div>"+t.columns[s].label+"</div></th>"}o+="</tr>";var h=document.createDocumentFragment(),d=document.createElement("div");d.className="atableParent";var u=document.createElement("table");u.className="atable",d.appendChild(u);var m=document.createElement("thead");u.appendChild(m);var g=document.createElement("tbody");if(g.style.maxHeight=this.height+"px",u.appendChild(g),h.appendChild(d),this.resizeIndicator||(this.resizeIndicator=e(),h.appendChild(this.resizeIndicator)),this.parentElt&&this.el.removeChild(this.parentElt[0]),this.el.appendChild(h),this.tableElt=$(u),this.parentElt=$(d),this.tbodyElt=$(g),!this.rowHeight){var f=document.createElement("tr");f.innerHTML="<td>0</td>",f.style.visibility="hidden",f.style.position="absolute",g.appendChild(f),this.rowHeight=f.offsetHeight,g.removeChild(f),this.visibleRows=parseInt(this.height/this.rowHeight,10)}if(!this.rowRange){var v=this.visibleRows+c;v>t.rows.length&&(v=t.rows.length),this.rowRange={first:0,last:v,prevFirst:0,prevLast:v}}for(var w="<tr style='height: "+i+"px;'></tr>",b=this.rowRange.first;t.rows.length>b&&this.rowRange.last>b;b++){w+="<tr>";for(var p=0;t.rows[b].row.length>p;p++){var C=t.columns[p].width;w+='<td><div style="width: '+C+'px;">'+t.rows[b].row[p]+"</div></td>"}w+="</tr>"}if(w+="<tr style='height: "+(this.rowHeight*(t.rows.length-this.visibleRows-c)-i)+"px;'></tr>",m.innerHTML=o,g.innerHTML=w,this.scrollbarWidth=l(g),this.scrollbarWidth>0){var R=t.columns[t.columns.length-1].width;$(g).find("td:last-child>div").width(R-this.scrollbarWidth)}},receivedData:function(t,e){this.scrollTop=this.$el.find(".table").scrollTop(),this.rows.init||(this.rows.init=!0);for(var i=[],n=0;t.length>n;n++)i.push(new Row({row:t[n]}));e?(this.dataAppended=!0,this.rows.add(i),this.rows.trigger("reset")):(this.reRenderTable=!0,this.rows.reset(i))},close:function(){this.resizeIndicator&&document.removeChild(this.resizeIndicator),this.remove(),this.unbind()}})}();