/*! aTable v0.1.0 - 2013-03-10 */
var Column=Backbone.Model.extend({}),Row=Backbone.Model.extend({defaults:{row:[]}}),ColumnCollection=Backbone.Collection.extend({initialize:function(){this.modelsByName={}},model:Column,comparator:function(t){return t.get("order")},getByName:function(t){return this.modelsByName[t]},renameColumn:function(t,e){if(!e)throw"Invalid column name";var o=this.modelsByName[t];o&&o.set({name:e})},moveColumn:function(t,e){var o=this.at(t),n=this.at(e);if(!o)throw"Invalid column index: "+t;if(!n)throw"Invalid column index: "+e;var s,r=o.get("order"),i=n.get("order");if(i>r)for(var l=r+1;i>=l;l++)s=this.at(l),s.set({order:s.get("order")-1});else for(var a=r-1;a>=i;a--)s=this.at(a),s.set({order:s.get("order")+1});o.set({order:i}),this.sort()},add:function(t,e){var o=this;t=_.isArray(t)?t.slice():[t];var n=[];_.forEach(t,function(t){t instanceof Backbone.Model||(t=new Column(t)),o.modelsByName[t.get("name")]||(o.modelsByName[t.get("name")]=t),n.push(t)}),Backbone.Collection.prototype.add.call(this,n,e)},remove:function(t,e){var o=this;t=_.isArray(t)?t.slice():[t],_.forEach(t,function(t){o.modelsByName[t.get("name")]&&delete o.modelsByName[t.get("name")]}),Backbone.Collection.prototype.remove.call(this,t,e)},reset:function(t,e){this.modelsByName={},Backbone.Collection.prototype.reset.call(this,t,e)}}),RowCollection=function(){function t(t,e,o){var n=t[e];t[e]=t[o],t[o]=n}return Backbone.Collection.extend({initialize:function(t,e){this.columnOrder=[],e?(this.sortColumn=e.sortColumn,this.sortDescending=null!==e.sortDescending?e.sortDescending:!1):(this.sortColumn=null,this.sortDescending=!1);for(var o=0;e.numColumns>o;o++)this.columnOrder.push(o)},model:Row,getValue:function(t,e){var o=this.at(t).get("row"),n=this.columnOrder[e];return o[n]},getRow:function(t){for(var e=this.at(t).get("row"),o=[],n=0;e.length>n;n++){var s=this.columnOrder[n];o.push(e[s])}return o},getColumnIndex:function(t){return this.columnOrder[t]},moveColumn:function(e,o){if(o>e){this.sortColumn>e&&o>=this.sortColumn?this.sortColumn--:this.sortColumn===e&&(this.sortColumn=o);for(var n=e;o>n;n++)t(this.columnOrder,n,n+1)}else{e>this.sortColumn&&this.sortColumn>=o?this.sortColumn++:this.sortColumn===e&&(this.sortColumn=o);for(var s=e;s>o;s--)t(this.columnOrder,s,s-1)}},setSortColumn:function(t){this.sortColumn===t?this.sortDescending=!this.sortDescending:this.sortColumn=t},comparator:function(t){var e=t.get("row")[this.columnOrder[this.sortColumn]],o=null;if("number"==typeof e)o=e;else if("object"==typeof e)o=e instanceof Date?e.getTime():0;else if("string"==typeof e)return this.sortDescending?(e=e.toLowerCase(),e=e.split(""),e=_.map(e,function(t){return String.fromCharCode(-t.charCodeAt(0))}),e.join("")):e;return this.sortDescending?-o:o}})}(),ATable=function(){function t(t){var e=t.offsetX,o=!t.target.previousElementSibling,n=$(t.target).closest("th")[0];return e===void 0&&(e=t.originalEvent.pageX-$(t.target).offset().left),!o&&d+1>=e?n.previousElementSibling.cellIndex:d>=t.target.offsetWidth-e?n.cellIndex:-1}function e(t){return null!==t.columns&&0===t.columns.length?"Columns array missing or empty":t.fetchData?null:"Missing fetchData arg: script tag id with fetchData function."}function o(t,e){if(window.Blob&&window.Worker){var o=new Blob([document.querySelector("#"+t).textContent," self.onmessage=function(){fetchData();};"]),n=window.URL||window.webkitURL,s=new Worker(n.createObjectURL(o));return s.onmessage=function(t){e(t.data.data,t.data.append)},s}throw"Blob and Worker support required to use the web worker interface."}function n(t,e){for(var o=e.columns,n=0;o.length>n;n++)o[n].width===void 0&&(o[n].width=l(o[n].name)+20),o[n].resizable===void 0&&(o[n].resizable=e.resizableColumns),o[n].sortable===void 0&&(o[n].sortable=e.sortable),o[n].order=n,t.availableColumnsArray.push(o[n].name),t.availableColumnsHash[o[n].name]=!0;return new ColumnCollection(o)}function s(t){for(var e=[],o=0;t.length>o;o++)e.push({row:t.getRow(o)});return e}function r(){var t=document.createElement("div");t.className="atable-scrollbar-measure",document.body.appendChild(t);var e=t.offsetWidth-t.clientWidth;return document.body.removeChild(t),e}function i(t,e){var o=document.createElement("div");o.classList.add("sortArrow"),o.innerHTML=e?"&darr;":"&uarr;",t.firstChild.appendChild(o)}function l(t){var e=$("<th>"+t+"</th>").css({position:"absolute","float":"left","white-space":"nowrap",visibility:"hidden"}).appendTo($("body")),o=e.width();return e.remove(),o}function a(t){t.resizableColumns===void 0&&(t.resizableColumns=!0),t.movableColumns===void 0&&(t.movableColumns=!0),t.sortable===void 0&&(t.sortable=!0)}var h=15,u=5,d=7;return Backbone.View.extend({initialize:function(t){_.bindAll(this),this.reRenderTable=!0;var s=e(t);if(s)throw s;if(a(t),this.availableColumnsArray=[],this.availableColumnsHash={},this.columns=n(this,t),this.columns.bind("reset",this.render,this),this.columns.bind("sort",this.render,this),this.movableColumns=t.movableColumns,"string"==typeof t.sortColumn){var i=this.columns.indexOf(t.sortColumn);t.sortColumn=i>=0?i:0}t.numColumns=this.columns.length,this.rows=new RowCollection([],t),this.rows.init=!1,this.columnTarget=null,"string"==typeof t.fetchData?this.dataWorker=o(t.fetchData,this.receivedData):"function"==typeof t.fetchData,this.height=t.height,this.prevScrollTop=0,this.scrollbarWidth=r()},events:{"click th":"onClickColumnHeader","mousemove th":"onMouseMoveColumnHeader","mouseleave th":"onMouseLeaveColumnHeader","dragstart th":"onStartDragColumnHeader",dragend:"onEndDragColumnHeader","dragenter th div":"onDragEnterColumnHeader","dragover th div":"onDragOverColumnHeader","dragleave th div":"onDragLeaveColumnHeader","drop th div":"onDropColumnHeader"},render:function(t){"function"==typeof t&&(this.renderCallback=t);var e={};if(!this.rows.init)return this.rows.bind("reset",this.render,this),this.rows.bind("sort",this.render,this),this.dataWorker.postMessage(null),this;if(this.reRenderTable){this.reRenderTable=!1,e.columns=this.columns.toJSON(),e.rows=s(this.rows),this.generateTableHtml(e);for(var o=this.tableElt.find("th"),n=0;o.length>n;n++)this.columns.at(n).set("element",$(o[n]));if(this.tbodyElt[0].scrollTop=this.prevScrollTop,$("tbody:not(.scrollBound)").addClass("scrollBound").bind("scroll",this.onTableScrolled),this.sizeTable(),"number"==typeof this.rows.sortColumn&&i(this.columns.at(this.rows.sortColumn).get("element")[0],this.rows.sortDescending),"function"==typeof this.renderCallback){var r=this.renderCallback;this.renderCallback=null,r()}}else this.renderRows(this.prevScrollTop,this.tbodyElt[0].scrollTop);return this},renderRows:function(t,e){var o,n;t>e?(o=this.rowRange.first,n=this.rowRange.prevFirst,this.rowRange.last<=this.rowRange.prevFirst&&(o=this.rowRange.first,n=this.rowRange.last),this.removeRows(n-o,!1),this.addRows(o,n,!0)):e>t?(o=this.rowRange.prevLast,n=this.rowRange.last,this.rowRange.first>=this.rowRange.prevLast&&(o=this.rowRange.first,n=this.rowRange.last),this.removeRows(n-o,!0),this.addRows(o,n,!1)):this.refreshRows(this.rowRange.first),this.prevScrollTop=this.tbodyElt[0].scrollTop},addRows:function(t,e,o){for(var n=this.tbodyElt[0].firstChild,s=this.tbodyElt[0].lastChild,r=n.nextSibling,i=Math.abs(this.rowRange.first-this.rowRange.prevFirst)*this.rowHeight,l=t;e>l;l++){for(var a=document.createElement("tr"),h=0;this.columns.length>h;h++){var u=document.createElement("div"),d=this.columns.at(h).get("element")[0].style.width;d=d.substr(0,d.length-2),h==this.columns.length-1&&(d-=this.scrollbarWidth-1),u.style.width=d+"px";var m=document.createTextNode(this.rows.getValue(l,h)),c=document.createElement("td");u.appendChild(m),c.appendChild(u),a.appendChild(c)}o?this.tbodyElt[0].insertBefore(a,r):this.tbodyElt[0].insertBefore(a,s)}if(i>0){var g,f;o?(f=s.style.height,s.style.height=Number(f.substr(0,f.length-2))+i+"px",g=n.style.height,n.style.height=Number(g.substr(0,g.length-2))-i+"px"):(f=s.style.height,s.style.height=Number(f.substr(0,f.length-2))-i+"px",g=n.style.height,n.style.height=Number(g.substr(0,g.length-2))+i+"px")}},removeRows:function(t,e){var o,n;if(t>this.visibleRows+2*u&&(t=this.visibleRows+2*u),e)o=2,n=t+2;else{var s=this.tbodyElt[0].childElementCount-2;o=s+2-t,n=s+2}for(var r=o;n>r;r++)this.tableElt[0].deleteRow(o)},refreshRows:function(t){for(var e=this.tbodyElt[0].getElementsByTagName("tr"),o=1;e.length-1>o;o++)for(var n=e[o],s=n.getElementsByTagName("div"),r=0;s.length>r;r++){var i=s[r];i.innerHTML=this.rows.getValue(t+o-1,r)}},sizeTable:function(){for(var t=this.tableElt.find("th"),e=1,o=0;t.length>o;o++)e+=$(t[o])[0].offsetWidth;$.browser.mozilla&&e--,this.tableElt.width(e),this.parentElt.width(e)},doPostRender:function(){$("th").contextMenu({menu:menu},this.initColumnMenu),2>this.columns.length?$("#columnMenu").disableContextMenuItems("#removeColumn"):$("#columnMenu").enableContextMenuItems("#removeColumn")},initColumnMenu:function(t,e,o){this.columnTarget=e.attr("id").split("_")[1],"addColumn"===t?this.showAddColumnDialog(o):"removeColumn"===t?this.removeColumn(this.columnTarget):"renameColumn"===t&&this.showRenameColumnDialog(this.columnTarget,e.text(),o)},showAddColumnDialog:function(t){return new EditColumnDialog({editType:"add",blotterType:this.blotterType,callBack:this.addColumn,columns:this.availableColumnsArray}).show(t),!1},showRenameColumnDialog:function(t,e,o){return new EditColumnDialog({editType:"rename",blotterType:this.blotterType,callBack:this.renameColumn}).show(o,t,e),!1},addColumn:function(t){var e=this.columns.getByName(this.columnTarget);if(!this.columns.getByName(t)&&this.availableColumnsHash[t]){for(var o=e.get("order"),n=o;this.columns.length>n;n++){var s=this.columns.at(n);s.set({order:s.get("order")+1},{silent:!0})}var r=l(t)+15;this.columns.add({columnName:t,entityField:t,blotterName:this.blotterType,order:o,width:r}),this.columns.save(this.admin)}},removeColumn:function(t){var e=this.columns.getByName(t);e.destroy();for(var o=e.get("order");this.columns.length>o;o++){var n=this.columns.at(o);n.set({order:n.get("order")-1})}},renameColumn:function(t,e){this.columns.renameColumn(e,t)},filter:function(){},moveColumn:function(t,e){this.reRenderTable=!0,this.rows.moveColumn(t,e),this.columns.moveColumn(t,e)},resizeColumn:function(t,e,o){var n=this.columns.at(t);if(!n)throw"Invalid column index: "+t;n.get("element")[0].style.width=e+"px",n.set("width",e),this.reRenderTable=!0,this.render(o)},sort:function(t,e){if(0>t||t>this.columns.length)throw"Invalid column index: "+t;this.tableElt.find(".sortArrow").remove(),this.rows.setSortColumn(t),"boolean"==typeof e&&(this.rows.sortDescending=e),i(this.columns.at(t).get("element")[0],this.rows.sortDescending),this.rows.sort()},onTableScrolled:function(t){var e=parseInt(t.target.scrollTop/this.rowHeight,10)-u;this.rowRange.prevFirst=this.rowRange.first,this.rowRange.prevLast=this.rowRange.last,0>e&&(e=0),this.rowRange.first=e,this.rowRange.last=e+this.visibleRows+u,this.rowRange.last>this.rows.length&&(this.rowRange.last=this.rows.length,this.rowRange.first=this.rowRange.last-this.visibleRows-u),this.renderRows(this.prevScrollTop,t.target.scrollTop)},onMouseMoveColumnHeader:function(e){var o=t(e),n=$(e.target).closest("th")[0];n.style.cursor=0>o||!this.columns.at(o).get("resizable")?null:"e-resize"},onMouseLeaveColumnHeader:function(t){var e=$(t.target).closest("th")[0];e.style.cursor=null},onClickColumnHeader:function(e){if(0>t(e)){var o=$(e.target).closest("th")[0];this.columns.at(o.cellIndex).get("sortable")&&this.sort(o.cellIndex)}},onStartDragColumnHeader:function(e){var o=$(e.target),n=t(e);if(n>-1){if(o=this.columns.at(n).get("element"),!this.columns.at(n).get("resizable"))return e.preventDefault&&e.preventDefault(),!1;var s,r,i=o.offset(),l=this.tableElt.parent().offset(),a=this.tableElt.height()+2,h=o.css("padding-left"),u=o.css("padding-right");i.left<l.left?(s=l.left,r=l.left-i.left):(s=i.left,r=0);var d=o.width()-r+Number(h.substring(0,h.length-2))+Number(u.substring(0,u.length-2))-5,m=$("#grayout");m.css("display","block").css("left",s).css("top",i.top-1).css("height",a).css("width",d).attr("title",o[0].cellIndex),document.addEventListener("dragover",this.onResizeGrayout),e.originalEvent.dataTransfer.setDragImage(document.createElement("div"),0,0),e.originalEvent.dataTransfer.setData("text",o[0].cellIndex)}else this.movableColumns?(e.target.style.opacity=.35,e.originalEvent.dataTransfer.setData("text",o[0].cellIndex)):e.preventDefault()},onResizeGrayout:function(t){var e=$("#grayout"),o=e.offset(),n=this.rows.getColumnIndex(Number(t.dataTransfer.getData("text"))),s=this.columns.at(n).get("element"),r=t.pageX-o.left,i=l(s.text())+h;r>=i?e.css("width",r):e.css("width",i)},onEndDragColumnHeader:function(t){var e=$("#grayout");if("none"===e.css("display"))t.target.style.opacity=null;else{document.removeEventListener("dragover",this.onResizeGrayout,!1);var o=parseInt(t.originalEvent.clientX-e.position().left-h,10),n=e.width(),s=Number(e.attr("title")),r=this.columns.at(s),i=r.get("element").offset(),l=this.tableElt.parent().offset();i.left<l.left&&(n+=l.left-i.left),o=n>o?n:o,e.css("display","none"),this.resizeColumn(s,o)}},onDragEnterColumnHeader:function(t){var e=t.originalEvent.dataTransfer.getData("text");if(this.movableColumns&&"none"===$("#grayout").css("display")){var o=$(t.target).closest("th")[0];o.cellIndex!=e&&o.firstChild.classList.add("over")}},onDragOverColumnHeader:function(t){t.preventDefault&&t.preventDefault()},onDragLeaveColumnHeader:function(t){t.target.classList.remove("over")},onDropColumnHeader:function(t){if(t.preventDefault&&t.preventDefault(),this.movableColumns&&"none"===$("#grayout").css("display")){var e=Number(t.originalEvent.dataTransfer.getData("text")),o=t.target.parentElement.cellIndex;"TH"===t.target.tagName?(o=t.target.cellIndex,t.target.firstChild.classList.remove("over")):t.target.classList.remove("over"),this.moveColumn(e,o)}},saveMouseState:function(t){this.isMouseDown=1===t.which?!0:!1},generateTableHtml:function(t){var e=0;if(this.tbodyElt){var o=this.tbodyElt[0].firstChild.style.height;e=o.substr(0,o.length-2)}for(var n="<tr>",s=0;t.columns.length>s;s++){var r="",i="";t.columns[s].width&&(r='style="width: '+t.columns[s].width+'px;"'),t.columns[s].sortable&&(i=' className="sortable"'),n+='<th draggable="true" '+r+i+"><div>"+t.columns[s].name+"</div></th>"}n+="</tr>";var l=document.createDocumentFragment(),a=document.createElement("div");a.className="atableParent";var h=document.createElement("table");h.className="atable",a.appendChild(h);var d=document.createElement("thead");h.appendChild(d);var m=document.createElement("tbody");m.style.height=this.height+"px",h.appendChild(m);var c=document.createElement("div");if(c.id="grayout",l.appendChild(a),l.appendChild(c),this.parentElt&&(this.el.removeChild(this.parentElt[0]),this.el.removeChild(document.getElementById("grayout"))),this.el.appendChild(l),this.tableElt=$(h),this.parentElt=$(a),this.tbodyElt=$(m),!this.rowHeight){var g=document.createElement("tr");g.innerHTML="<td>0</td>",g.style.visibility="hidden",g.style.position="absolute",m.appendChild(g),this.rowHeight=g.offsetHeight,m.removeChild(g),this.visibleRows=parseInt(this.height/this.rowHeight,10)}this.rowRange||(this.rowRange={first:0,last:this.visibleRows+u,prevFirst:0,prevLast:this.visibleRows+u});for(var f="<tr style='height: "+e+"px;'></tr>",v=this.rowRange.first;t.rows.length>v&&this.rowRange.last>v;v++){f+="<tr>";for(var w=0;t.rows[v].row.length>w;w++){var b=t.columns[w].width;v===t.rows[v].row.length-1&&(b-=this.scrollbarWidth+2),f+='<td><div style="width: '+b+'px;">'+t.rows[v].row[w]+"</div></td>"}f+="</tr>"}f+="<tr style='height: "+(this.rowHeight*(this.rows.length-this.visibleRows-u)-e)+"px;'></tr>",d.innerHTML=n,m.innerHTML=f},receivedData:function(t,e){this.scrollTop=this.$el.find(".table").scrollTop(),this.rows.init||(this.rows.init=!0);for(var o=[],n=0;t.length>n;n++)o.push(new Row({row:t[n]}));e?(this.rows.add(o),this.rows.trigger("reset")):this.rows.reset(o)},close:function(){this.remove(),this.unbind()}})}();