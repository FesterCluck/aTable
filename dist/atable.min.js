/*! aTable v0.1.0 - 2013-03-05 */
var Column=Backbone.Model.extend({}),Row=Backbone.Model.extend({defaults:{row:[]}}),ColumnCollection=Backbone.Collection.extend({initialize:function(){this.modelsByName={}},model:Column,comparator:function(t){return t.get("order")},getByName:function(t){return this.modelsByName[t]},renameColumn:function(t,e){if(!e)throw"Invalid column name";var o=this.modelsByName[t];o&&o.set({name:e})},moveColumn:function(t,e){var o=this.at(t),r=this.at(e);if(!o)throw"Invalid column index: "+t;if(!r)throw"Invalid column index: "+e;var n,s=o.get("order"),i=r.get("order");if(i>s)for(var l=s+1;i>=l;l++)n=this.at(l),n.set({order:n.get("order")-1});else for(var a=s-1;a>=i;a--)n=this.at(a),n.set({order:n.get("order")+1});o.set({order:i}),this.sort()},add:function(t,e){var o=this;t=_.isArray(t)?t.slice():[t];var r=[];_.forEach(t,function(t){t instanceof Backbone.Model||(t=new Column(t)),o.modelsByName[t.get("name")]||(o.modelsByName[t.get("name")]=t),r.push(t)}),Backbone.Collection.prototype.add.call(this,r,e)},remove:function(t,e){var o=this;t=_.isArray(t)?t.slice():[t],_.forEach(t,function(t){o.modelsByName[t.get("name")]&&delete o.modelsByName[t.get("name")]}),Backbone.Collection.prototype.remove.call(this,t,e)},reset:function(t,e){this.modelsByName={},Backbone.Collection.prototype.reset.call(this,t,e)}}),RowCollection=function(){function t(t,e,o){var r=t[e];t[e]=t[o],t[o]=r}return Backbone.Collection.extend({initialize:function(t,e){this.columnOrder=[],e?(this.sortColumn=e.sortColumn,this.sortDescending=null!==e.sortDescending?e.sortDescending:!1):(this.sortColumn=null,this.sortDescending=!1);for(var o=0;e.numColumns>o;o++)this.columnOrder.push(o)},model:Row,getValue:function(t,e){var o=this.at(t).get("row"),r=this.columnOrder[e];return o[r]},getRow:function(t){for(var e=this.at(t).get("row"),o=[],r=0;e.length>r;r++){var n=this.columnOrder[r];o.push(e[n])}return o},getColumnIndex:function(t){return this.columnOrder[t]},moveColumn:function(e,o){if(o>e){this.sortColumn>e&&o>=this.sortColumn?this.sortColumn--:this.sortColumn===e&&(this.sortColumn=o);for(var r=e;o>r;r++)t(this.columnOrder,r,r+1)}else{e>this.sortColumn&&this.sortColumn>=o?this.sortColumn++:this.sortColumn===e&&(this.sortColumn=o);for(var n=e;n>o;n--)t(this.columnOrder,n,n-1)}},setSortColumn:function(t){this.sortColumn===t?this.sortDescending=!this.sortDescending:this.sortColumn=t},comparator:function(t){var e=t.get("row")[this.columnOrder[this.sortColumn]],o=null;if("number"==typeof e)o=e;else if("object"==typeof e)o=e instanceof Date?e.getTime():0;else if("string"==typeof e)return this.sortDescending?(e=e.toLowerCase(),e=e.split(""),e=_.map(e,function(t){return String.fromCharCode(-t.charCodeAt(0))}),e.join("")):e;return this.sortDescending?-o:o}})}(),ATable=function(){function t(t){return null!==t.columns&&0===t.columns.length?"Cannot specify empty 'columns' array":t.fetchData?null:"Missing fetchData arg: script tag id containing function to fetch the table data."}function e(t,e){if(window.Blob){var o=new Blob([document.querySelector("#"+t).textContent," self.onmessage=function(p){self.postMessage(fetchData(p));};"]),r=window.URL||window.webkitURL,n=new Worker(r.createObjectURL(o));return n.onmessage=function(t){e(t.data)},n}throw"Support for Blob constructor required"}function o(t,e){for(var o=0;e.length>o;o++)e[o].width===void 0&&(e[o].width=i(e[o].name)+20),e[o].order=o,t.availableColumnsArray.push(e[o].name),t.availableColumnsHash[e[o].name]=!0;return new ColumnCollection(e)}function r(t){for(var e=[],o=0;t.length>o;o++)e.push({row:t.getRow(o)});return e}function n(){var t=document.createElement("div");t.className="atable-scrollbar-measure",document.body.appendChild(t);var e=t.offsetWidth-t.clientWidth;return document.body.removeChild(t),e}function s(t,e){var o=document.createElement("div");o.classList.add("sortArrow"),o.innerHTML=e?"&darr;":"&uarr;",t.firstChild.appendChild(o)}function i(t){var e=$("<th>"+t+"</th>").css({position:"absolute","float":"left","white-space":"nowrap",visibility:"hidden"}).appendTo($("body")),o=e.width();return e.remove(),o}var l=15,a=5;return Backbone.View.extend({initialize:function(r){_.bindAll(this),this.reRenderTable=!0;var s=t(r);if(s)return console.error(s),void 0;if(this.availableColumnsArray=[],this.availableColumnsHash={},this.columns=o(this,r.columns),this.columns.bind("reset",this.render,this),this.columns.bind("sort",this.render,this),"string"==typeof r.sortColumn){var i=this.columns.indexOf(r.sortColumn);r.sortColumn=i>=0?i:0}r.numColumns=this.columns.length,this.rows=new RowCollection([],r),this.rows.init=!1,this.columnTarget=null,this.dataWorker=e(r.fetchData,this.receivedData),this.height=r.height,this.prevScrollTop=0,this.scrollbarWidth=n()},events:{"click th":"onClickColumnHeader","mousemove th":"onMouseMoveColumnHeader","dragstart th":"onStartDragColumnHeader",dragend:"onEndDragColumnHeader","dragenter th div":"onDragEnterColumnHeader","dragover th div":"onDragOverColumnHeader","dragleave th div":"onDragLeaveColumnHeader","drop th div":"onDropColumnHeader"},render:function(t){"function"==typeof t&&(this.renderCallback=t);var e={};if(!this.rows.init)return this.rows.bind("reset",this.render,this),this.rows.bind("sort",this.render,this),this.dataWorker.postMessage(null),this;if(this.reRenderTable){this.reRenderTable=!1,e.columns=this.columns.toJSON(),e.rows=r(this.rows),this.generateTableHtml(e);for(var o=this.tableElt.find("th"),n=0;o.length>n;n++)this.columns.at(n).set("element",$(o[n]));if(this.tbodyElt[0].scrollTop=this.prevScrollTop,$("tbody:not(.scrollBound)").addClass("scrollBound").bind("scroll",this.onTableScrolled),this.sizeTable(),"number"==typeof this.rows.sortColumn&&s(this.columns.at(this.rows.sortColumn).get("element")[0],this.rows.sortDescending),"function"==typeof this.renderCallback){var i=this.renderCallback;this.renderCallback=null,i()}}else this.renderRows(this.prevScrollTop,this.tbodyElt[0].scrollTop);return this},renderRows:function(t,e){var o,r;t>e?(o=this.rowRange.first,r=this.rowRange.prevFirst,this.rowRange.last<=this.rowRange.prevFirst&&(o=this.rowRange.first,r=this.rowRange.last),this.removeRows(r-o,!1),this.addRows(o,r,!0)):e>t?(o=this.rowRange.prevLast,r=this.rowRange.last,this.rowRange.first>=this.rowRange.prevLast&&(o=this.rowRange.first,r=this.rowRange.last),this.removeRows(r-o,!0),this.addRows(o,r,!1)):this.refreshRows(this.rowRange.first),this.prevScrollTop=this.tbodyElt[0].scrollTop},addRows:function(t,e,o){for(var r=this.tbodyElt[0].firstChild,n=this.tbodyElt[0].lastChild,s=r.nextSibling,i=Math.abs(this.rowRange.first-this.rowRange.prevFirst)*this.rowHeight,l=t;e>l;l++){for(var a=document.createElement("tr"),h=0;this.columns.length>h;h++){var u=document.createElement("div"),d=this.columns.at(h).get("element")[0].style.width;d=d.substr(0,d.length-2),h==this.columns.length-1&&(d-=this.scrollbarWidth-1),u.style.width=d+"px";var m=document.createTextNode(this.rows.getValue(l,h)),c=document.createElement("td");u.appendChild(m),c.appendChild(u),a.appendChild(c)}o?this.tbodyElt[0].insertBefore(a,s):this.tbodyElt[0].insertBefore(a,n)}if(i>0){var g,f;o?(f=n.style.height,n.style.height=Number(f.substr(0,f.length-2))+i+"px",g=r.style.height,r.style.height=Number(g.substr(0,g.length-2))-i+"px"):(f=n.style.height,n.style.height=Number(f.substr(0,f.length-2))-i+"px",g=r.style.height,r.style.height=Number(g.substr(0,g.length-2))+i+"px")}},removeRows:function(t,e){var o,r;if(t>this.visibleRows+2*a&&(t=this.visibleRows+2*a),e)o=2,r=t+2;else{var n=this.tbodyElt[0].childElementCount-2;o=n+2-t,r=n+2}for(var s=o;r>s;s++)this.tableElt[0].deleteRow(o)},refreshRows:function(t){for(var e=this.tbodyElt[0].getElementsByTagName("tr"),o=1;e.length-1>o;o++)for(var r=e[o],n=r.getElementsByTagName("div"),s=0;n.length>s;s++){var i=n[s];i.innerHTML=this.rows.getValue(t+o-1,s)}},onTableScrolled:function(t){var e=parseInt(t.target.scrollTop/this.rowHeight,10)-a;this.rowRange.prevFirst=this.rowRange.first,this.rowRange.prevLast=this.rowRange.last,0>e&&(e=0),this.rowRange.first=e,this.rowRange.last=e+this.visibleRows+a,this.rowRange.last>this.rows.length&&(this.rowRange.last=this.rows.length,this.rowRange.first=this.rowRange.last-this.visibleRows-a),this.renderRows(this.prevScrollTop,t.target.scrollTop)},doPostRender:function(){$("th").contextMenu({menu:menu},this.initColumnMenu),2>this.columns.length?$("#columnMenu").disableContextMenuItems("#removeColumn"):$("#columnMenu").enableContextMenuItems("#removeColumn")},initColumnMenu:function(t,e,o){this.columnTarget=e.attr("id").split("_")[1],"addColumn"===t?this.showAddColumnDialog(o):"removeColumn"===t?this.removeColumn(this.columnTarget):"renameColumn"===t&&this.showRenameColumnDialog(this.columnTarget,e.text(),o)},sort:function(t,e){if(0>t||t>this.columns.length)throw"Invalid column index: "+t;this.tableElt.find(".sortArrow").remove(),this.rows.setSortColumn(t),"boolean"==typeof e&&(this.rows.sortDescending=e),s(this.columns.at(t).get("element")[0],this.rows.sortDescending),this.rows.sort()},onClickColumnHeader:function(t){this.mouseInResizePosition(t)||("DIV"===t.target.tagName?"sortArrow"===t.target.className?this.sort(t.target.parentElement.parentElement.cellIndex):this.sort(t.target.parentElement.cellIndex):this.sort(t.target.cellIndex))},showAddColumnDialog:function(t){return new EditColumnDialog({editType:"add",blotterType:this.blotterType,callBack:this.addColumn,columns:this.availableColumnsArray}).show(t),!1},showRenameColumnDialog:function(t,e,o){return new EditColumnDialog({editType:"rename",blotterType:this.blotterType,callBack:this.renameColumn}).show(o,t,e),!1},addColumn:function(t){var e=this.columns.getByName(this.columnTarget);if(!this.columns.getByName(t)&&this.availableColumnsHash[t]){for(var o=e.get("order"),r=o;this.columns.length>r;r++){var n=this.columns.at(r);n.set({order:n.get("order")+1},{silent:!0})}var s=i(t)+15;this.columns.add({columnName:t,entityField:t,blotterName:this.blotterType,order:o,width:s}),this.columns.save(this.admin)}},removeColumn:function(t){var e=this.columns.getByName(t);e.destroy();for(var o=e.get("order");this.columns.length>o;o++){var r=this.columns.at(o);r.set({order:r.get("order")-1})}},renameColumn:function(t,e){this.columns.renameColumn(e,t)},moveColumn:function(t,e){this.reRenderTable=!0,this.rows.moveColumn(t,e),this.columns.moveColumn(t,e)},resizeColumn:function(t,e,o){var r=this.columns.at(t);if(!r)throw"Invalid column index: "+t;r.get("element")[0].style.width=e+"px",r.set("width",e),this.reRenderTable=!0,this.render(o)},onMouseMoveColumnHeader:function(t){this.mouseInResizePosition(t)?"e-resize"!==$(t.target).css("cursor")&&$(t.target).css("cursor","e-resize"):$(t.target).css("cursor","pointer")},mouseInResizePosition:function(t){var e=this.getMouseColumnOffset(t),o=!t.target.previousElementSibling;return!o&&6>=e||5>=t.target.offsetWidth-e},getMouseColumnOffset:function(t){var e=t.offsetX;return e===void 0&&(e=t.originalEvent.pageX-$(t.target).offset().left),e},sizeTable:function(){for(var t=this.tableElt.find("th"),e=1,o=0;t.length>o;o++)e+=$(t[o])[0].offsetWidth;$.browser.mozilla&&e--,this.tableElt.width(e),this.parentElt.width(e)},onStartDragColumnHeader:function(t){var e=$(t.target);if(this.mouseInResizePosition(t)){e=4>=this.getMouseColumnOffset(t)?$(t.target.previousSibling):$(t.target);var o,r,n=e.offset(),s=this.tableElt.parent().offset(),i=this.tableElt.height()+2,l=e.css("padding-left"),a=e.css("padding-right");n.left<s.left?(o=s.left,r=s.left-n.left):(o=n.left,r=0);var h=e.width()-r+Number(l.substring(0,l.length-2))+Number(a.substring(0,a.length-2))-5,u=$("#grayout");u.css("display","block").css("left",o).css("top",n.top-1).css("height",i).css("width",h).attr("title",e[0].cellIndex),document.addEventListener("dragover",this.onResizeGrayout),t.originalEvent.dataTransfer.setDragImage(document.createElement("div"),0,0)}else t.target.style.opacity=.35;t.originalEvent.dataTransfer.setData("text",e[0].cellIndex)},onResizeGrayout:function(t){var e=$("#grayout"),o=e.offset(),r=this.rows.getColumnIndex(Number(t.dataTransfer.getData("text"))),n=this.columns.at(r).get("element"),s=t.pageX-o.left,a=i(n.text())+l;s>=a?e.css("width",s):e.css("width",a)},onEndDragColumnHeader:function(t){var e=$("#grayout");if("none"===e.css("display"))t.target.style.opacity=1;else{document.removeEventListener("dragover",this.onResizeGrayout,!1);var o=parseInt(t.originalEvent.clientX-e.position().left-l,10),r=e.width(),n=Number(e.attr("title")),s=this.columns.at(n),i=s.get("element").offset(),a=this.tableElt.parent().offset();i.left<a.left&&(r+=a.left-i.left),o=r>o?r:o,e.css("display","none"),this.resizeColumn(n,o)}},onDragEnterColumnHeader:function(t){var e=t.originalEvent.dataTransfer.getData("text");"none"===$("#grayout").css("display")&&("TH"===t.target.parentElement.tagName&&t.target.parentElement.cellIndex!=e?t.target.classList.add("over"):"DIV"===t.target.parentElement.tagName&&t.target.parentElement.parentElement.cellIndex!=e&&t.target.parentElement.classList.add("over"))},onDragOverColumnHeader:function(t){t.preventDefault&&t.preventDefault()},onDragLeaveColumnHeader:function(t){t.target.classList.remove("over")},onDropColumnHeader:function(t){if(t.preventDefault&&t.preventDefault(),"none"===$("#grayout").css("display")){var e=Number(t.originalEvent.dataTransfer.getData("text")),o=t.target.parentElement.cellIndex;"TH"===t.target.tagName?(o=t.target.cellIndex,t.target.firstChild.classList.remove("over")):t.target.classList.remove("over"),this.moveColumn(e,o)}},saveMouseState:function(t){this.isMouseDown=1===t.which?!0:!1},generateTableHtml:function(t){var e=0;if(this.tbodyElt){var o=this.tbodyElt[0].firstChild.style.height;e=o.substr(0,o.length-2)}for(var r="<tr>",n=0;t.columns.length>n;n++){var s="";t.columns[n].width&&(s='style="width: '+t.columns[n].width+'px;"'),r+='<th draggable="true" '+s+"><div>"+t.columns[n].name+"</div></th>"}r+="</tr>";var i=document.createDocumentFragment(),l=document.createElement("div");l.className="atableParent";var h=document.createElement("table");h.className="atable",l.appendChild(h);var u=document.createElement("thead");h.appendChild(u);var d=document.createElement("tbody");d.style.height=this.height+"px",h.appendChild(d);var m=document.createElement("div");if(m.id="grayout",i.appendChild(l),i.appendChild(m),this.parentElt&&(this.el.removeChild(this.parentElt[0]),this.el.removeChild(document.getElementById("grayout"))),this.el.appendChild(i),this.tableElt=$(h),this.parentElt=$(l),this.tbodyElt=$(d),!this.rowHeight){var c=document.createElement("tr");c.innerHTML="<td>0</td>",c.style.visibility="hidden",c.style.position="absolute",d.appendChild(c),this.rowHeight=c.offsetHeight,d.removeChild(c),this.visibleRows=parseInt(this.height/this.rowHeight,10)}this.rowRange||(this.rowRange={first:0,last:this.visibleRows+a,prevFirst:0,prevLast:this.visibleRows+a});for(var g="<tr style='height: "+e+"px;'></tr>",f=this.rowRange.first;t.rows.length>f&&this.rowRange.last>f;f++){g+="<tr>";for(var v=0;t.rows[f].row.length>v;v++){var w=t.columns[v].width;f===t.rows[f].row.length-1&&(w-=this.scrollbarWidth-1),g+='<td><div style="width: '+w+'px;">'+t.rows[f].row[v]+"</div></td>"}g+="</tr>"}g+="<tr style='height: "+(this.rowHeight*(this.rows.length-this.visibleRows-a)-e)+"px;'></tr>",u.innerHTML=r,d.innerHTML=g},receivedData:function(t){this.scrollTop=this.$el.find(".table").scrollTop(),this.rows.init||(this.rows.init=!0);var e=this.rows.comparator;this.rows.__proto__.comparator=null;for(var o=0;t.length>o;o++)this.rows.add({row:t[o]},{silent:!0});this.rows.__proto__.comparator=e,this.rows.trigger("reset")},close:function(){this.remove(),this.unbind()}})}();