/*! aTable v0.1.0 - 2013-03-16 */
var Column=Backbone.Model.extend({}),Row=Backbone.Model.extend({defaults:{row:[]}}),ColumnCollection=Backbone.Collection.extend({initialize:function(){this.modelsByName={}},model:Column,comparator:function(t){return t.get("order")},getByName:function(t){return this.modelsByName[t]},renameColumn:function(t,e){if(!e)throw"Invalid column name";var o=this.modelsByName[t];o&&o.set({name:e})},moveColumn:function(t,e){var o=this.at(t),s=this.at(e);if(!o)throw"Invalid column index: "+t;if(!s)throw"Invalid column index: "+e;var n,r=o.get("order"),i=s.get("order");if(i>r)for(var l=r+1;i>=l;l++)n=this.at(l),n.set({order:n.get("order")-1});else for(var a=r-1;a>=i;a--)n=this.at(a),n.set({order:n.get("order")+1});o.set({order:i}),this.sort()},add:function(t,e){var o=this;t=_.isArray(t)?t.slice():[t];var s=[];_.forEach(t,function(t){t instanceof Backbone.Model||(t=new Column(t)),o.modelsByName[t.get("name")]||(o.modelsByName[t.get("name")]=t),s.push(t)}),Backbone.Collection.prototype.add.call(this,s,e)},remove:function(t,e){var o=this;t=_.isArray(t)?t.slice():[t],_.forEach(t,function(t){o.modelsByName[t.get("name")]&&delete o.modelsByName[t.get("name")]}),Backbone.Collection.prototype.remove.call(this,t,e)},reset:function(t,e){this.modelsByName={},Backbone.Collection.prototype.reset.call(this,t,e)}}),RowCollection=function(){function t(t,e,o){var s=t[e];t[e]=t[o],t[o]=s}return Backbone.Collection.extend({initialize:function(t,e){this.columnOrder=[],e?(this.sortColumn=e.sortColumn,this.sortDescending=null!==e.sortDescending?e.sortDescending:!1):(this.sortColumn=null,this.sortDescending=!1);for(var o=0;e.numColumns>o;o++)this.columnOrder.push(o)},model:Row,getValue:function(t,e){var o=this.at(t).get("row"),s=this.columnOrder[e];return o[s]},getRow:function(t){for(var e=this.at(t).get("row"),o=[],s=0;e.length>s;s++){var n=this.columnOrder[s];o.push(e[n])}return o},getColumnIndex:function(t){return this.columnOrder[t]},moveColumn:function(e,o){if(o>e){this.sortColumn>e&&o>=this.sortColumn?this.sortColumn--:this.sortColumn===e&&(this.sortColumn=o);for(var s=e;o>s;s++)t(this.columnOrder,s,s+1)}else{e>this.sortColumn&&this.sortColumn>=o?this.sortColumn++:this.sortColumn===e&&(this.sortColumn=o);for(var n=e;n>o;n--)t(this.columnOrder,n,n-1)}},setSortColumn:function(t){this.sortColumn===t?this.sortDescending=!this.sortDescending:this.sortColumn=t},comparator:function(t){var e=t.get("row")[this.columnOrder[this.sortColumn]],o=null;if("number"==typeof e)o=e;else if("object"==typeof e)o=e instanceof Date?e.getTime():0;else if("string"==typeof e)return this.sortDescending?(e=e.toLowerCase(),e=e.split(""),e=_.map(e,function(t){return String.fromCharCode(-t.charCodeAt(0))}),e.join("")):e;return this.sortDescending?-o:o}})}(),ATable=function(){function t(t,e,o,s){var n=t.childElementCount-2,r=(e.length-n)*o;if(0>r)t.firstChild.style.height=0,t.lastChild.style.height=0;else{var i=s*o,l=r-i;t.firstChild.style.height=i+"px",t.lastChild.style.height=l+"px"}}function e(t){var e=t.offsetX,o=!t.target.previousElementSibling,s=$(t.target).closest("th")[0];return e===void 0&&(e=t.originalEvent.pageX-$(t.target).offset().left),!o&&m+1>=e?s.previousElementSibling.cellIndex:m>=t.target.offsetWidth-e?s.cellIndex:-1}function o(t){return null!==t.columns&&0===t.columns.length?"Columns array missing or empty":t.fetchData?null:"Missing fetchData arg: script tag id with fetchData function."}function s(t,e){if(window.Blob&&window.Worker){var o=new Blob([document.querySelector("#"+t).textContent," self.onmessage=function(){fetchData();};"]),s=window.URL||window.webkitURL,n=new Worker(s.createObjectURL(o));return n.onmessage=function(t){e(t.data.data,t.data.append)},n}throw"Blob and Worker support required to use the web worker interface."}function n(t,e){for(var o=e.columns,s=0;o.length>s;s++)o[s].width===void 0&&(o[s].width=a(o[s].name)+20),o[s].resizable===void 0&&(o[s].resizable=e.resizableColumns),o[s].sortable===void 0&&(o[s].sortable=e.sortable),o[s].order=s,t.availableColumnsArray.push(o[s].name),t.availableColumnsHash[o[s].name]=!0;return new ColumnCollection(o)}function r(t){for(var e=[],o=0;t.length>o;o++)e.push({row:t.getRow(o)});return e}function i(t){return t?t.offsetWidth-t.clientWidth:0}function l(t,e){var o=document.createElement("div");o.classList.add("sortArrow"),o.innerHTML=e?"&darr;":"&uarr;",t.firstChild.appendChild(o)}function a(t){var e=$("<th>"+t+"</th>").css({position:"absolute","float":"left","white-space":"nowrap",visibility:"hidden"}).appendTo($("body")),o=e.width();return e.remove(),o}function h(t){t.resizableColumns===void 0&&(t.resizableColumns=!0),t.movableColumns===void 0&&(t.movableColumns=!0),t.sortable===void 0&&(t.sortable=!0)}var d=15,u=5,m=7;return Backbone.View.extend({initialize:function(t){_.bindAll(this),this.reRenderTable=!0,this.dataAppended=!1;var e=o(t);if(e)throw e;if(h(t),this.availableColumnsArray=[],this.availableColumnsHash={},this.columns=n(this,t),this.columns.bind("reset",this.render,this),this.columns.bind("sort",this.render,this),this.movableColumns=t.movableColumns,"string"==typeof t.sortColumn){var r=this.columns.indexOf(t.sortColumn);t.sortColumn=r>=0?r:0}t.numColumns=this.columns.length,this.rows=new RowCollection([],t),this.rows.init=!1,this.columnTarget=null,"string"==typeof t.fetchData?this.dataWorker=s(t.fetchData,this.receivedData):"function"==typeof t.fetchData,this.height=t.height,this.prevScrollTop=0},events:{"click th":"onClickColumnHeader","mousemove th":"onMouseMoveColumnHeader","mouseleave th":"onMouseLeaveColumnHeader","dragstart th":"onStartDragColumnHeader",dragend:"onEndDragColumnHeader","dragenter th div":"onDragEnterColumnHeader","dragover th div":"onDragOverColumnHeader","dragleave th div":"onDragLeaveColumnHeader","drop th div":"onDropColumnHeader"},render:function(t){"function"==typeof t&&(this.renderCallback=t);var e={};if(!this.rows.init)return this.rows.bind("reset",this.render,this),this.rows.bind("sort",this.render,this),this.dataWorker.postMessage(null),this;if(this.reRenderTable){this.reRenderTable=!1,e.columns=this.columns.toJSON(),e.rows=r(this.rows),this.tbodyElt&&(this.prevScrollTop=this.tbodyElt[0].scrollTop),this.generateTableHtml(e);for(var o=this.tableElt.find("th"),s=0;o.length>s;s++)this.columns.at(s).set("element",$(o[s]));if(this.tbodyElt[0].scrollTop=this.prevScrollTop,$("tbody:not(.scrollBound)").addClass("scrollBound").bind("scroll",this.onTableScrolled),this.sizeTable(),"number"==typeof this.rows.sortColumn&&l(this.columns.at(this.rows.sortColumn).get("element")[0],this.rows.sortDescending),"function"==typeof this.renderCallback){var n=this.renderCallback;this.renderCallback=null,n()}}else this.renderRows(this.prevScrollTop,this.tbodyElt[0].scrollTop);return this},renderRows:function(e,o){var s,n,r=this.visibleRows+u;if(e>o)s=this.rowRange.first,n=this.rowRange.prevFirst,this.rowRange.last<=this.rowRange.prevFirst&&(s=this.rowRange.first,n=this.rowRange.last),this.removeRows(n-s,!1),this.addRows(s,n,!0),t(this.tbodyElt[0],this.rows,this.rowHeight,this.rowRange.first);else if(o>e)s=this.rowRange.prevLast,n=this.rowRange.last,this.rowRange.first>=this.rowRange.prevLast&&(s=this.rowRange.first,n=this.rowRange.last),this.removeRows(n-s,!0),this.addRows(s,n,!1),t(this.tbodyElt[0],this.rows,this.rowHeight,this.rowRange.first);else{if(!this.dataAppended)return this.refreshRows(this.rowRange.first),void 0;this.dataAppended=!1,this.rowRange.last<this.rows.length&&r>this.rowRange.last&&(s=this.rowRange.last,n=this.rows.length,n>r&&(n=r),this.addRows(s,n,!1),this.rowRange.last=n),t(this.tbodyElt[0],this.rows,this.rowHeight,this.rowRange.first)}if(this.scrollbarWidth=i(this.tbodyElt[0]),this.scrollbarWidth>0){var l=this.columns.at(this.columns.length-1).get("width");this.tbodyElt.find("td:last-child>div").width(l-this.scrollbarWidth)}this.prevScrollTop=this.tbodyElt[0].scrollTop},addRows:function(t,e,o){for(var s=this.tbodyElt[0].firstChild,n=this.tbodyElt[0].lastChild,r=o?s.nextElementSibling:n,i=t;e>i;i++)this.addRow(i,r)},addRow:function(t,e){for(var o=document.createElement("tr"),s=0;this.columns.length>s;s++){var n=document.createElement("div"),r=this.columns.at(s).get("width");n.style.width=r+"px",n.innerHTML=this.rows.getValue(t,s);var i=document.createElement("td");i.appendChild(n),o.appendChild(i)}this.tbodyElt[0].insertBefore(o,e)},removeRows:function(t,e){var o,s;if(t>this.visibleRows+2*u&&(t=this.visibleRows+2*u),e)o=2,s=t+2;else{var n=this.tbodyElt[0].childElementCount-2;o=n+2-t,s=n+2}for(var r=o;s>r;r++)this.tableElt[0].deleteRow(o)},refreshRows:function(t){var e=this.tbodyElt[0].getElementsByTagName("tr"),o=e.length-2;this.visibleRows+2*u>o&&this.rows.length>o&&this.addRows(this.rowRange.prevFirst,this.rowRange.last,!0),e=this.tbodyElt[0].getElementsByTagName("tr");for(var s=1;e.length-1>s;s++)for(var n=e[s],r=n.getElementsByTagName("div"),i=0;r.length>i;i++){var l=r[i];l.innerHTML=this.rows.getValue(t+s-1,i)}},sizeTable:function(){for(var t=this.tableElt.find("th"),e=1,o=0;t.length>o;o++)e+=$(t[o])[0].offsetWidth;$.browser.mozilla&&e--,this.tableElt.width(e),this.parentElt.width(e)},doPostRender:function(){$("th").contextMenu({menu:menu},this.initColumnMenu),2>this.columns.length?$("#columnMenu").disableContextMenuItems("#removeColumn"):$("#columnMenu").enableContextMenuItems("#removeColumn")},initColumnMenu:function(t,e,o){this.columnTarget=e.attr("id").split("_")[1],"addColumn"===t?this.showAddColumnDialog(o):"removeColumn"===t?this.removeColumn(this.columnTarget):"renameColumn"===t&&this.showRenameColumnDialog(this.columnTarget,e.text(),o)},showAddColumnDialog:function(t){return new EditColumnDialog({editType:"add",blotterType:this.blotterType,callBack:this.addColumn,columns:this.availableColumnsArray}).show(t),!1},showRenameColumnDialog:function(t,e,o){return new EditColumnDialog({editType:"rename",blotterType:this.blotterType,callBack:this.renameColumn}).show(o,t,e),!1},addColumn:function(t){var e=this.columns.getByName(this.columnTarget);if(!this.columns.getByName(t)&&this.availableColumnsHash[t]){for(var o=e.get("order"),s=o;this.columns.length>s;s++){var n=this.columns.at(s);n.set({order:n.get("order")+1},{silent:!0})}var r=a(t)+15;this.columns.add({columnName:t,entityField:t,blotterName:this.blotterType,order:o,width:r}),this.columns.save(this.admin)}},removeColumn:function(t){var e=this.columns.getByName(t);e.destroy();for(var o=e.get("order");this.columns.length>o;o++){var s=this.columns.at(o);s.set({order:s.get("order")-1})}},renameColumn:function(t,e){this.columns.renameColumn(e,t)},filter:function(){},moveColumn:function(t,e){this.reRenderTable=!0,this.rows.moveColumn(t,e),this.columns.moveColumn(t,e)},resizeColumn:function(t,e,o){var s=this.columns.at(t);if(!s)throw"Invalid column index: "+t;s.set("width",e),this.reRenderTable=!0,this.render(o)},sort:function(t,e){if(0>t||t>this.columns.length)throw"Invalid column index: "+t;this.tableElt.find(".sortArrow").remove(),this.rows.setSortColumn(t),"boolean"==typeof e&&(this.rows.sortDescending=e),l(this.columns.at(t).get("element")[0],this.rows.sortDescending),this.rows.sort()},onTableScrolled:function(t){if(this.prevScrollTop!==t.target.scrollTop){var e=parseInt(t.target.scrollTop/this.rowHeight,10)-u;0>e&&(e=0),this.rowRange.prevFirst=this.rowRange.first,this.rowRange.prevLast=this.rowRange.last,this.rowRange.first=e,this.rowRange.last=e+this.visibleRows+u,this.rowRange.last>this.rows.length&&(this.rowRange.last=this.rows.length,this.rowRange.first=this.rowRange.last-this.visibleRows-u),this.renderRows(this.prevScrollTop,t.target.scrollTop)}},onMouseMoveColumnHeader:function(t){var o=e(t),s=$(t.target).closest("th")[0];s.style.cursor=0>o||!this.columns.at(o).get("resizable")?null:"e-resize"},onMouseLeaveColumnHeader:function(t){var e=$(t.target).closest("th")[0];e.style.cursor=null},onClickColumnHeader:function(t){if(0>e(t)){var o=$(t.target).closest("th")[0];this.columns.at(o.cellIndex).get("sortable")&&this.sort(o.cellIndex)}},onStartDragColumnHeader:function(t){var o=$(t.target),s=e(t);if(s>-1){if(o=this.columns.at(s).get("element"),!this.columns.at(s).get("resizable"))return t.preventDefault&&t.preventDefault(),!1;var n,r,i=o.offset(),l=this.tableElt.parent().offset(),a=this.tableElt.height()+2,h=o.css("padding-left"),d=o.css("padding-right");i.left<l.left?(n=l.left,r=l.left-i.left):(n=i.left,r=0);var u=o.width()-r+Number(h.substring(0,h.length-2))+Number(d.substring(0,d.length-2))-5,m=$("#grayout");m.css("display","block").css("left",n).css("top",i.top-1).css("height",a).css("width",u).attr("title",o[0].cellIndex),document.addEventListener("dragover",this.onResizeGrayout),t.originalEvent.dataTransfer.setDragImage(document.createElement("div"),0,0),t.originalEvent.dataTransfer.setData("text",o[0].cellIndex)}else this.movableColumns?(t.target.style.opacity=.35,t.originalEvent.dataTransfer.setData("text",o[0].cellIndex)):t.preventDefault()},onResizeGrayout:function(t){var e=$("#grayout"),o=e.offset(),s=this.rows.getColumnIndex(Number(t.dataTransfer.getData("text"))),n=this.columns.at(s).get("element"),r=t.pageX-o.left,i=a(n.text())+d;r>=i?e.css("width",r):e.css("width",i)},onEndDragColumnHeader:function(t){var e=$("#grayout");if("none"===e.css("display"))t.target.style.opacity=null;else{document.removeEventListener("dragover",this.onResizeGrayout,!1);var o=parseInt(t.originalEvent.clientX-e.position().left-d,10),s=e.width(),n=Number(e.attr("title")),r=this.columns.at(n),i=r.get("element").offset(),l=this.tableElt.parent().offset();i.left<l.left&&(s+=l.left-i.left),o=s>o?s:o,e.css("display","none"),this.resizeColumn(n,o)}},onDragEnterColumnHeader:function(t){var e=t.originalEvent.dataTransfer.getData("text");if(this.movableColumns&&"none"===$("#grayout").css("display")){var o=$(t.target).closest("th")[0];o.cellIndex!=e&&o.firstChild.classList.add("over")}},onDragOverColumnHeader:function(t){t.preventDefault&&t.preventDefault()},onDragLeaveColumnHeader:function(t){t.target.classList.remove("over")},onDropColumnHeader:function(t){if(t.preventDefault&&t.preventDefault(),this.movableColumns&&"none"===$("#grayout").css("display")){var e=Number(t.originalEvent.dataTransfer.getData("text")),o=t.target.parentElement.cellIndex;"TH"===t.target.tagName?(o=t.target.cellIndex,t.target.firstChild.classList.remove("over")):t.target.classList.remove("over"),this.moveColumn(e,o)}},generateTableHtml:function(t){var e=0;if(this.tbodyElt){var o=this.tbodyElt[0].firstChild.style.height;e=o.substr(0,o.length-2)}for(var s="<tr>",n=0;t.columns.length>n;n++){var r="",l="";t.columns[n].width&&(r='style="width: '+t.columns[n].width+'px;"'),t.columns[n].sortable&&(l=' className="sortable"'),s+='<th draggable="true" '+r+l+"><div>"+t.columns[n].name+"</div></th>"}s+="</tr>";var a=document.createDocumentFragment(),h=document.createElement("div");h.className="atableParent";var d=document.createElement("table");d.className="atable",h.appendChild(d);var m=document.createElement("thead");d.appendChild(m);var c=document.createElement("tbody");c.style.height=this.height+"px",d.appendChild(c);var g=document.createElement("div");if(g.id="grayout",a.appendChild(h),a.appendChild(g),this.parentElt&&(this.el.removeChild(this.parentElt[0]),this.el.removeChild(document.getElementById("grayout"))),this.el.appendChild(a),this.tableElt=$(d),this.parentElt=$(h),this.tbodyElt=$(c),!this.rowHeight){var f=document.createElement("tr");f.innerHTML="<td>0</td>",f.style.visibility="hidden",f.style.position="absolute",c.appendChild(f),this.rowHeight=f.offsetHeight,c.removeChild(f),this.visibleRows=parseInt(this.height/this.rowHeight,10)}if(!this.rowRange){var v=this.visibleRows+u;v>t.rows.length&&(v=t.rows.length),this.rowRange={first:0,last:v,prevFirst:0,prevLast:v}}for(var w="<tr style='height: "+e+"px;'></tr>",p=this.rowRange.first;t.rows.length>p&&this.rowRange.last>p;p++){w+="<tr>";for(var b=0;t.rows[p].row.length>b;b++){var C=t.columns[b].width;w+='<td><div style="width: '+C+'px;">'+t.rows[p].row[b]+"</div></td>"}w+="</tr>"}if(w+="<tr style='height: "+(this.rowHeight*(t.rows.length-this.visibleRows-u)-e)+"px;'></tr>",m.innerHTML=s,c.innerHTML=w,this.scrollbarWidth=i(c),this.scrollbarWidth>0){var y=t.columns[t.columns.length-1].width;$(c).find("td:last-child>div").width(y-this.scrollbarWidth)}},receivedData:function(t,e){this.scrollTop=this.$el.find(".table").scrollTop(),this.rows.init||(this.rows.init=!0);for(var o=[],s=0;t.length>s;s++)o.push(new Row({row:t[s]}));e?(this.dataAppended=!0,this.rows.add(o),this.rows.trigger("reset")):(this.reRenderTable=!0,this.rows.reset(o))},close:function(){this.remove(),this.unbind()}})}();