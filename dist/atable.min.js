/*! aTable v0.1.0 - 2013-03-18 */
var Column=Backbone.Model.extend({initialize:function(){}}),Row=Backbone.Model.extend({initialize:function(){},defaults:{row:[]}}),ColumnCollection=Backbone.Collection.extend({initialize:function(){this.modelsByName={}},model:Column,comparator:function(t){return t.get("order")},getByName:function(t){return this.modelsByName[t]},renameColumn:function(t,e){if(!e)throw"Invalid column name";var o=this.modelsByName[t];o&&o.set({name:e})},moveColumn:function(t,e){var o=this.at(t),n=this.at(e);if(!o)throw"Invalid column index: "+t;if(!n)throw"Invalid column index: "+e;var s,i=o.get("order"),r=n.get("order");if(r>i)for(var l=i+1;r>=l;l++)s=this.at(l),s.set({order:s.get("order")-1});else for(var a=i-1;a>=r;a--)s=this.at(a),s.set({order:s.get("order")+1});o.set({order:r}),this.sort()},add:function(t,e){var o=this;t=_.isArray(t)?t.slice():[t];var n=[];_.forEach(t,function(t){t instanceof Backbone.Model||(t=new Column(t)),o.modelsByName[t.get("name")]||(o.modelsByName[t.get("name")]=t),n.push(t)}),Backbone.Collection.prototype.add.call(this,n,e)},remove:function(t,e){var o=this;t=_.isArray(t)?t.slice():[t],_.forEach(t,function(t){o.modelsByName[t.get("name")]&&delete o.modelsByName[t.get("name")]}),Backbone.Collection.prototype.remove.call(this,t,e)},reset:function(t,e){this.modelsByName={},Backbone.Collection.prototype.reset.call(this,t,e)}}),RowCollection=function(){function t(t,e,o){var n=t[e];t[e]=t[o],t[o]=n}return Backbone.Collection.extend({initialize:function(t,e){this.columnOrder=[],e?(this.sortColumn=e.sortColumn,this.sortDescending=null!==e.sortDescending?e.sortDescending:!1):(this.sortColumn=null,this.sortDescending=!1);for(var o=0;e.numColumns>o;o++)this.columnOrder.push(o)},model:Row,getValue:function(t,e){var o=this.at(t).get("row"),n=this.columnOrder[e];return o[n]},getRow:function(t){for(var e=this.at(t).get("row"),o=[],n=0;e.length>n;n++){var s=this.columnOrder[n];o.push(e[s])}return o},getColumnIndex:function(t){return this.columnOrder[t]},moveColumn:function(e,o){if(o>e){this.sortColumn>e&&o>=this.sortColumn?this.sortColumn--:this.sortColumn===e&&(this.sortColumn=o);for(var n=e;o>n;n++)t(this.columnOrder,n,n+1)}else{e>this.sortColumn&&this.sortColumn>=o?this.sortColumn++:this.sortColumn===e&&(this.sortColumn=o);for(var s=e;s>o;s--)t(this.columnOrder,s,s-1)}},setSortColumn:function(t){this.sortColumn===t?this.sortDescending=!this.sortDescending:this.sortColumn=t},comparator:function(t){var e=t.get("row")[this.columnOrder[this.sortColumn]],o=null;if("number"==typeof e)o=e;else if("object"==typeof e)o=e instanceof Date?e.getTime():0;else if("string"==typeof e)return this.sortDescending?(e=e.toLowerCase(),e=e.split(""),e=_.map(e,function(t){return String.fromCharCode(-t.charCodeAt(0))}),e.join("")):e;return this.sortDescending?-o:o}})}(),ATable=function(){function t(t,e,o,n){var s=t.childElementCount-2,i=(e.length-s)*o;if(0>i)t.firstChild.style.height=0,t.lastChild.style.height=0;else{var r=n*o,l=i-r;t.firstChild.style.height=r+"px",t.lastChild.style.height=l+"px"}}function e(t){var e=t.offsetX,o=!t.target.previousElementSibling,n=$(t.target).closest("th")[0];return e===void 0&&(e=t.originalEvent.pageX-$(t.target).offset().left),!o&&m+1>=e?n.previousElementSibling.cellIndex:m>=t.target.offsetWidth-e?n.cellIndex:-1}function o(t){return null!==t.columns&&0===t.columns.length?"Columns array missing or empty":t.dataFunction?null:"Missing dataFunction arg: actual function or script tag id with fetchData function"}function n(t,e){if(window.Blob&&window.Worker){var o=new Blob([document.querySelector("#"+t).textContent," self.onmessage=function(){fetchData();};"]),n=window.URL||window.webkitURL,s=new Worker(n.createObjectURL(o));return s.onmessage=function(t){e(t.data.data,t.data.append)},s}throw"Blob and Worker support required to use the web worker interface."}function s(t,e){for(var o=e.columns,n=0;o.length>n;n++)o[n].width===void 0&&(o[n].width=a(o[n].name)+20),o[n].resizable===void 0&&(o[n].resizable=e.resizableColumns),o[n].sortable===void 0&&(o[n].sortable=e.sortable),o[n].order=n,t.availableColumnsArray.push(o[n].name),t.availableColumnsHash[o[n].name]=!0;return new ColumnCollection(o)}function i(t){for(var e=[],o=0;t.length>o;o++)e.push({row:t.getRow(o)});return e}function r(t){return t?t.offsetWidth-t.clientWidth:0}function l(t,e){var o=document.createElement("div");o.classList.add("sortArrow"),o.innerHTML=e?"&darr;":"&uarr;",t.firstChild.appendChild(o)}function a(t){var e=$("<th>"+t+"</th>").css({position:"absolute","float":"left","white-space":"nowrap",visibility:"hidden"}).appendTo($("body")),o=e.width();return e.remove(),o}function h(t){t.resizableColumns===void 0&&(t.resizableColumns=!0),t.movableColumns===void 0&&(t.movableColumns=!0),t.sortable===void 0&&(t.sortable=!0)}var d=15,u=5,m=7;return Backbone.View.extend({initialize:function(t){_.bindAll(this),"string"==typeof t.dataFunction?this.dataWorker=n(t.dataFunction,this.receivedData):"function"==typeof t.dataFunction&&(this.dataFunction=t.dataFunction),this.reRenderTable=!0,this.dataAppended=!1;var e=o(t);if(e)throw e;if(h(t),this.availableColumnsArray=[],this.availableColumnsHash={},this.columns=s(this,t),this.columns.bind("reset",this.render,this),this.columns.bind("sort",this.render,this),this.movableColumns=t.movableColumns,"string"==typeof t.sortColumn){var i=this.columns.indexOf(t.sortColumn);t.sortColumn=i>=0?i:0}t.numColumns=this.columns.length,this.rows=new RowCollection([],t),this.rows.init=!1,this.columnTarget=null,this.height=t.height,this.prevScrollTop=0},events:{"click th":"onClickColumnHeader","mousemove th":"onMouseMoveColumnHeader","mouseleave th":"onMouseLeaveColumnHeader","dragstart th":"onStartDragColumnHeader",dragend:"onEndDragColumnHeader","dragenter th div":"onDragEnterColumnHeader","dragover th div":"onDragOverColumnHeader","dragleave th div":"onDragLeaveColumnHeader","drop th div":"onDropColumnHeader"},render:function(t){"function"==typeof t&&(this.renderCallback=t);var e={};if(!this.rows.init)return this.rows.bind("reset",this.render,this),this.rows.bind("sort",this.render,this),this.dataWorker?this.dataWorker.postMessage(null):this.dataFunction(this),this;if(this.reRenderTable){this.reRenderTable=!1,e.columns=this.columns.toJSON(),e.rows=i(this.rows),this.tbodyElt&&(this.prevScrollTop=this.tbodyElt[0].scrollTop),this.generateTableHtml(e);for(var o=this.tableElt.find("th"),n=0;o.length>n;n++)this.columns.at(n).set("element",$(o[n]));if(this.tbodyElt[0].scrollTop=this.prevScrollTop,$("tbody:not(.scrollBound)").addClass("scrollBound").bind("scroll",this.onTableScrolled),this.sizeTable(),"number"==typeof this.rows.sortColumn&&l(this.columns.at(this.rows.sortColumn).get("element")[0],this.rows.sortDescending),"function"==typeof this.renderCallback){var s=this.renderCallback;this.renderCallback=null,s()}}else this.renderRows(this.prevScrollTop,this.tbodyElt[0].scrollTop);return this},renderRows:function(e,o){var n,s,i=this.visibleRows+u;if(e>o)n=this.rowRange.first,s=this.rowRange.prevFirst,this.rowRange.last<=this.rowRange.prevFirst&&(n=this.rowRange.first,s=this.rowRange.last),this.removeRows(s-n,!1),this.addRows(n,s,!0),t(this.tbodyElt[0],this.rows,this.rowHeight,this.rowRange.first);else if(o>e)n=this.rowRange.prevLast,s=this.rowRange.last,this.rowRange.first>=this.rowRange.prevLast&&(n=this.rowRange.first,s=this.rowRange.last),this.removeRows(s-n,!0),this.addRows(n,s,!1),t(this.tbodyElt[0],this.rows,this.rowHeight,this.rowRange.first);else{if(!this.dataAppended)return this.refreshRows(this.rowRange.first),void 0;this.dataAppended=!1,this.rowRange.last<this.rows.length&&i>this.rowRange.last&&(n=this.rowRange.last,s=this.rows.length,s>i&&(s=i),this.addRows(n,s,!1),this.rowRange.last=s),t(this.tbodyElt[0],this.rows,this.rowHeight,this.rowRange.first)}if(this.scrollbarWidth=r(this.tbodyElt[0]),this.scrollbarWidth>0){var l=this.columns.at(this.columns.length-1).get("width");this.tbodyElt.find("td:last-child>div").width(l-this.scrollbarWidth)}this.prevScrollTop=this.tbodyElt[0].scrollTop},addRows:function(t,e,o){for(var n=this.tbodyElt[0].firstChild,s=this.tbodyElt[0].lastChild,i=o?n.nextElementSibling:s,r=t;e>r;r++)this.addRow(r,i)},addRow:function(t,e){for(var o=document.createElement("tr"),n=0;this.columns.length>n;n++){var s=document.createElement("div"),i=this.columns.at(n).get("width");s.style.width=i+"px",s.innerHTML=this.rows.getValue(t,n);var r=document.createElement("td");r.appendChild(s),o.appendChild(r)}this.tbodyElt[0].insertBefore(o,e)},removeRows:function(t,e){var o,n;if(t>this.visibleRows+2*u&&(t=this.visibleRows+2*u),e)o=2,n=t+2;else{var s=this.tbodyElt[0].childElementCount-2;o=s+2-t,n=s+2}for(var i=o;n>i;i++)this.tableElt[0].deleteRow(o)},refreshRows:function(t){var e=this.tbodyElt[0].getElementsByTagName("tr");e.length-2,e=this.tbodyElt[0].getElementsByTagName("tr");for(var o=1;e.length-1>o;o++)for(var n=e[o],s=n.getElementsByTagName("div"),i=0;s.length>i;i++){var r=s[i];r.innerHTML=this.rows.getValue(t+o-1,i)}},sizeTable:function(){for(var t=this.tableElt.find("th"),e=1,o=0;t.length>o;o++)e+=$(t[o])[0].offsetWidth;$.browser.mozilla&&e--,this.tableElt.width(e),this.parentElt.width(e)},doPostRender:function(){$("th").contextMenu({menu:menu},this.initColumnMenu),2>this.columns.length?$("#columnMenu").disableContextMenuItems("#removeColumn"):$("#columnMenu").enableContextMenuItems("#removeColumn")},initColumnMenu:function(t,e,o){this.columnTarget=e.attr("id").split("_")[1],"addColumn"===t?this.showAddColumnDialog(o):"removeColumn"===t?this.removeColumn(this.columnTarget):"renameColumn"===t&&this.showRenameColumnDialog(this.columnTarget,e.text(),o)},showAddColumnDialog:function(t){return new EditColumnDialog({editType:"add",blotterType:this.blotterType,callBack:this.addColumn,columns:this.availableColumnsArray}).show(t),!1},showRenameColumnDialog:function(t,e,o){return new EditColumnDialog({editType:"rename",blotterType:this.blotterType,callBack:this.renameColumn}).show(o,t,e),!1},addColumn:function(t){var e=this.columns.getByName(this.columnTarget);if(!this.columns.getByName(t)&&this.availableColumnsHash[t]){for(var o=e.get("order"),n=o;this.columns.length>n;n++){var s=this.columns.at(n);s.set({order:s.get("order")+1},{silent:!0})}var i=a(t)+15;this.columns.add({columnName:t,entityField:t,blotterName:this.blotterType,order:o,width:i}),this.columns.save(this.admin)}},removeColumn:function(t){var e=this.columns.getByName(t);e.destroy();for(var o=e.get("order");this.columns.length>o;o++){var n=this.columns.at(o);n.set({order:n.get("order")-1})}},renameColumn:function(t,e){this.columns.renameColumn(e,t)},filter:function(){},moveColumn:function(t,e){this.reRenderTable=!0,this.rows.moveColumn(t,e),this.columns.moveColumn(t,e)},resizeColumn:function(t,e,o){var n=this.columns.at(t);if(!n)throw"Invalid column index: "+t;n.set("width",e),this.reRenderTable=!0,this.render(o)},sort:function(t,e){if(0>t||t>this.columns.length)throw"Invalid column index: "+t;this.tableElt.find(".sortArrow").remove(),this.rows.setSortColumn(t),"boolean"==typeof e&&(this.rows.sortDescending=e),l(this.columns.at(t).get("element")[0],this.rows.sortDescending),this.rows.sort()},onTableScrolled:function(t){if(this.prevScrollTop!==t.target.scrollTop){var e=parseInt(t.target.scrollTop/this.rowHeight,10)-u;0>e&&(e=0),this.rowRange.prevFirst=this.rowRange.first,this.rowRange.prevLast=this.rowRange.last,this.rowRange.first=e,this.rowRange.last=e+this.visibleRows+u,this.rowRange.last>this.rows.length&&(this.rowRange.last=this.rows.length,this.rowRange.first=this.rowRange.last-this.visibleRows-u),this.renderRows(this.prevScrollTop,t.target.scrollTop)}},onMouseMoveColumnHeader:function(t){var o=e(t),n=$(t.target).closest("th")[0];n.style.cursor=0>o||!this.columns.at(o).get("resizable")?null:"e-resize"},onMouseLeaveColumnHeader:function(t){var e=$(t.target).closest("th")[0];e.style.cursor=null},onClickColumnHeader:function(t){if(0>e(t)){var o=$(t.target).closest("th")[0];this.columns.at(o.cellIndex).get("sortable")&&this.sort(o.cellIndex)}},onStartDragColumnHeader:function(t){var o=$(t.target),n=e(t);if(n>-1){if(o=this.columns.at(n).get("element"),!this.columns.at(n).get("resizable"))return t.preventDefault&&t.preventDefault(),!1;var s,i,r=o.offset(),l=this.tableElt.parent().offset(),a=this.tableElt.height()+2,h=o.css("padding-left"),d=o.css("padding-right");r.left<l.left?(s=l.left,i=l.left-r.left):(s=r.left,i=0);var u=o.width()-i+Number(h.substring(0,h.length-2))+Number(d.substring(0,d.length-2))-5,m=$("#grayout");m.css("display","block").css("left",s).css("top",r.top-1).css("height",a).css("width",u).attr("title",o[0].cellIndex),document.addEventListener("dragover",this.onResizeGrayout),t.originalEvent.dataTransfer.setDragImage(document.createElement("div"),0,0),t.originalEvent.dataTransfer.setData("text",o[0].cellIndex)}else this.movableColumns?(t.target.style.opacity=.35,t.originalEvent.dataTransfer.setData("text",o[0].cellIndex)):t.preventDefault()},onResizeGrayout:function(t){var e=$("#grayout"),o=e.offset(),n=this.rows.getColumnIndex(Number(t.dataTransfer.getData("text"))),s=this.columns.at(n).get("element"),i=t.pageX-o.left,r=a(s.text())+d;i>=r?e.css("width",i):e.css("width",r)},onEndDragColumnHeader:function(t){var e=$("#grayout");if("none"===e.css("display"))t.target.style.opacity=null;else{document.removeEventListener("dragover",this.onResizeGrayout,!1);var o=parseInt(t.originalEvent.clientX-e.position().left-d,10),n=e.width(),s=Number(e.attr("title")),i=this.columns.at(s),r=i.get("element").offset(),l=this.tableElt.parent().offset();r.left<l.left&&(n+=l.left-r.left),o=n>o?n:o,e.css("display","none"),this.resizeColumn(s,o)}},onDragEnterColumnHeader:function(t){var e=t.originalEvent.dataTransfer.getData("text");if(this.movableColumns&&"none"===$("#grayout").css("display")){var o=$(t.target).closest("th")[0];o.cellIndex!=e&&o.firstChild.classList.add("over")}},onDragOverColumnHeader:function(t){t.preventDefault&&t.preventDefault()},onDragLeaveColumnHeader:function(t){t.target.classList.remove("over")},onDropColumnHeader:function(t){if(t.preventDefault&&t.preventDefault(),this.movableColumns&&"none"===$("#grayout").css("display")){var e=Number(t.originalEvent.dataTransfer.getData("text")),o=t.target.parentElement.cellIndex;"TH"===t.target.tagName?(o=t.target.cellIndex,t.target.firstChild.classList.remove("over")):t.target.classList.remove("over"),this.moveColumn(e,o)}},generateTableHtml:function(t){var e=0;if(this.tbodyElt){var o=this.tbodyElt[0].firstChild.style.height;e=o.substr(0,o.length-2)}for(var n="<tr>",s=0;t.columns.length>s;s++){var i="",l="";t.columns[s].width&&(i='style="width: '+t.columns[s].width+'px;"'),t.columns[s].sortable&&(l=' className="sortable"'),n+='<th draggable="true" '+i+l+"><div>"+t.columns[s].name+"</div></th>"}n+="</tr>";var a=document.createDocumentFragment(),h=document.createElement("div");h.className="atableParent";var d=document.createElement("table");d.className="atable",h.appendChild(d);var m=document.createElement("thead");d.appendChild(m);var c=document.createElement("tbody");c.style.maxHeight=this.height+"px",d.appendChild(c);var g=document.createElement("div");if(g.id="grayout",a.appendChild(h),a.appendChild(g),this.parentElt&&(this.el.removeChild(this.parentElt[0]),this.el.removeChild(document.getElementById("grayout"))),this.el.appendChild(a),this.tableElt=$(d),this.parentElt=$(h),this.tbodyElt=$(c),!this.rowHeight){var f=document.createElement("tr");f.innerHTML="<td>0</td>",f.style.visibility="hidden",f.style.position="absolute",c.appendChild(f),this.rowHeight=f.offsetHeight,c.removeChild(f),this.visibleRows=parseInt(this.height/this.rowHeight,10)}if(!this.rowRange){var v=this.visibleRows+u;v>t.rows.length&&(v=t.rows.length),this.rowRange={first:0,last:v,prevFirst:0,prevLast:v}}for(var w="<tr style='height: "+e+"px;'></tr>",p=this.rowRange.first;t.rows.length>p&&this.rowRange.last>p;p++){w+="<tr>";for(var b=0;t.rows[p].row.length>b;b++){var C=t.columns[b].width;w+='<td><div style="width: '+C+'px;">'+t.rows[p].row[b]+"</div></td>"}w+="</tr>"}if(w+="<tr style='height: "+(this.rowHeight*(t.rows.length-this.visibleRows-u)-e)+"px;'></tr>",m.innerHTML=n,c.innerHTML=w,this.scrollbarWidth=r(c),this.scrollbarWidth>0){var y=t.columns[t.columns.length-1].width;$(c).find("td:last-child>div").width(y-this.scrollbarWidth)}},receivedData:function(t,e){this.scrollTop=this.$el.find(".table").scrollTop(),this.rows.init||(this.rows.init=!0);for(var o=[],n=0;t.length>n;n++)o.push(new Row({row:t[n]}));e?(this.dataAppended=!0,this.rows.add(o),this.rows.trigger("reset")):(this.reRenderTable=!0,this.rows.reset(o))},close:function(){this.remove(),this.unbind()}})}();