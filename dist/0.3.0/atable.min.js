/*!
 * aTable v0.3.0
 * Copyright (c) 2012-2013 Jared Wolinsky
 * Licensed under the MIT License - http://opensource.org/licenses/MIT
 */
var ATable=function(){var t=Backbone.Model.extend({initialize:function(){this.on("change:label",function(t,e){var i=this.get("element");if(i)for(var r=0;i[0].firstChild.childNodes.length>r;r++){var s=i[0].firstChild.childNodes[r];if(3===s.nodeType){s.textContent=e;break}}})},idAttribute:"name"}),e=Backbone.Model.extend({initialize:function(){},defaults:{row:[]}}),i=Backbone.Collection.extend({initialize:function(){},model:t,comparator:function(t){return t.get("order")},renameColumn:function(t,e){if(!e)throw"Invalid column name";var i=this.get(t);i&&i.set({label:e})},moveColumn:function(t,e){var i=this.at(t),r=this.at(e);if(!i)throw"Invalid column index: "+t;if(!r)throw"Invalid column index: "+e;var s,o=i.get("order"),n=r.get("order");if(n>o)for(var l=o+1;n>=l;l++)s=this.at(l),s.set({order:s.get("order")-1});else for(var a=o-1;a>=n;a--)s=this.at(a),s.set({order:s.get("order")+1});i.set({order:n}),this.sort()}}),r=function(){function t(t,e,i){var r=t[e];t[e]=t[i],t[i]=r}return Backbone.Collection.extend({initialize:function(t,e){this.init=!1,this.columnOrder=[],this.columns=e.columns,this.filterObj=null,this.visibleCount=t.length,this.formatter=e.formatter,e?(this.sortColumn=e.sortColumn,this.sortDescending=null!==e.sortDescending?e.sortDescending:!1):(this.sortColumn=null,this.sortDescending=!1);for(var i=0;e.columns.length>i;i++)this.columnOrder.push(i)},model:e,getValue:function(t,e){var i=this.at(t).get("row"),r=this.columnOrder[e];return i[r]},setValue:function(t,e,i){var r=this.at(t).get("row"),s=this.columnOrder[e];r[s]=i},getRow:function(t){for(var e=this.at(t).get("row"),i=[],r=0;e.length>r;r++){var s=this.columnOrder[r];i.push(e[s])}return i},getColumnIndex:function(t){return this.columnOrder[t]},moveColumn:function(e,i){if(i>e){this.sortColumn>e&&i>=this.sortColumn?this.sortColumn--:this.sortColumn===e&&(this.sortColumn=i);for(var r=e;i>r;r++)t(this.columnOrder,r,r+1)}else{e>this.sortColumn&&this.sortColumn>=i?this.sortColumn++:this.sortColumn===e&&(this.sortColumn=i);for(var s=e;s>i;s--)t(this.columnOrder,s,s-1)}},setSortColumn:function(t){this.sortColumn===t?this.sortDescending=!this.sortDescending:this.sortColumn=t},filter:function(t,e,i){if(e=""+e,!this.filterObj||e!==this.filter.str||this.filter.column!==t||this.filter.caseSensitive!==i){this.filterObj={str:e,column:t,caseSensitive:i},this.visibleCount=0;var r=this;return this.each(function(t){r.passesFilter(t.get("row"))?(t.set({visible:!0}),r.visibleCount++):t.set({visible:!1})}),!0}return!1},passesFilter:function(t){if(t&&this.filterObj){var e=""+t[this.columnOrder[this.filterObj.column]],i=this.filterObj.str;return this.filterObj.caseSensitive||(e=e.toUpperCase(),i=i.toUpperCase()),-1!==e.indexOf(i)}return!0},comparator:function(t){var e=this.columnOrder[this.sortColumn],i=this.formatter(t.get("row")[e],this.indexOf(t),e,this.columns.at(e).get("name")),r=0;if("number"==typeof i)r=i;else if("object"==typeof i)i instanceof Date&&(r=i.getTime());else if("string"==typeof i)return i=$("<div>"+i+"</div>").text(),this.sortDescending?(i=i.toLowerCase(),i=i.split(""),i=_.map(i,function(t){return String.fromCharCode(-t.charCodeAt(0))}),i.join("")):i;return this.sortDescending?-r:r},add:function(t,i){if(i=i||{},"[object Array]"===Object.prototype.toString.call(t))for(var r=0;t.length>r;r++){var s=t[r];s instanceof e||(s=new e(s));var o=this.passesFilter(s.get("row"));s.set({visible:o}),o&&this.visibleCount++}else{t instanceof e||(t=new e(t));var n=this.passesFilter(t.get("row"));t.set({visible:n}),n&&this.visibleCount++}"number"!=typeof this.sortColumn&&(i.sort=!1),Backbone.Collection.prototype.add.call(this,t,i)},reset:function(t,e){e=e||{},this.visibleCount=0,"number"!=typeof this.sortColumn&&(e.sort=!1),Backbone.Collection.prototype.reset.call(this,t,e)}})}(),s=function(){function t(t,e,i,r){var s=t.childElementCount-2,o=(e.visibleCount-s)*i;if(0>o)t.firstChild.style.height=0,t.lastChild.style.height=0;else{var n=r*i,l=o-n;t.firstChild.style.height=n+"px",t.lastChild.style.height=l+"px"}}function s(t){var e=0;$(".resizeIndicator").each(function(){e=parseInt(this.id.split("resize")[1],10)+1});var i=document.createElement("div");i.className="resizeIndicator",i.id="resize"+e,t.atableId=e,t.resizeIndicator=i}function o(t){var e=t.offsetX,i=!t.target.previousElementSibling,r=$(t.target).closest("th")[0];return e===void 0&&(e=t.originalEvent.pageX-$(t.target).offset().left),!i&&f+1>=e?r.previousElementSibling.getAttribute("data-column"):f>=t.target.offsetWidth-e?r.getAttribute("data-column"):null}function n(t){return null!==t.columns&&0===t.columns.length?"Columns array missing or empty":t.dataFunction?null:"Missing dataFunction arg: actual function or script tag id with data function"}function l(t,e){var i,r=document.querySelector("#"+t).textContent+" self.onmessage=function(){"+t+"();};";if("function"==typeof Blob)i=new Blob([r]);else{var s=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if(!s)throw"Blob support required to use the web worker interface.";var o=new s;o.append(r),i=o.getBlob()}if(Worker){var n=window.URL||window.webkitURL,l=new Worker(n.createObjectURL(i));return l.onmessage=function(t){e(t.data.data,t.data.append)},l}throw"Worker support required to use the web worker interface."}function a(t){for(var e=t.columns,r=0;e.length>r;r++)e[r].width===void 0&&(e[r].width=u(e[r].label)+20),e[r].resizable===void 0&&(e[r].resizable=t.resizableColumns),e[r].sortable===void 0&&(e[r].sortable=t.sortable),e[r].label===void 0&&(e[r].label=e[r].name),e[r].visible===void 0&&(e[r].visible=!0),e[r].editable===void 0&&(e[r].editable=t.editable),e[r].cellClasses===void 0&&(e[r].cellClasses=t.cellClasses),e[r].order=r;return new i(e)}function h(t){for(var e=[],i=0;t.length>i;i++)e.push({row:t.getRow(i),visible:t.at(i).get("visible")});return e}function d(t){return t?t.offsetWidth-t.clientWidth:0}function u(t){var e=$("<th>"+t+"</th>").css({position:"absolute","float":"left","white-space":"nowrap",visibility:"hidden"}).appendTo($("body")),i=e.width();return e.remove(),i}function c(t){t.resizableColumns===void 0&&(t.resizableColumns=!0),t.movableColumns===void 0&&(t.movableColumns=!0),t.sortable===void 0&&(t.sortable=!0),t.editable===void 0&&(t.editable=!1)}function m(){var t=null,e=navigator.userAgent.toLowerCase();return e.indexOf("safari")>-1&&(t=e.indexOf("chrome")>-1?"chrome":"safari"),t}var g=5,f=7,v=20;return Backbone.View.extend({initialize:function(t){_.bindAll(this),"string"==typeof t.dataFunction?this.dataWorker=l(t.dataFunction,this.receivedData):"function"==typeof t.dataFunction&&(this.dataFunction=t.dataFunction),t.formatter=t.formatter||function(t){return t},this.formatter=t.formatter,this.browser=m(),this.renderTable=!0,this.dataAppended=!1;var e=n(t);if(e)throw e;if(c(t),this.columns=a(t),this.columns.bind("reset",this.render,this),this.columns.bind("sort",this.render,this),this.columns.bind("change:visible",this.render,this),this.movableColumns=t.movableColumns,"string"==typeof t.sortColumn){var i=this.columns.indexOf(t.sortColumn);t.sortColumn=i>0?i:0}t.columns=this.columns,this.rows=new r([],t),this.height=t.height,this.prevScrollTop=0,this.atableId=0},events:{"click th":"onClickColumnHeader","mousemove th":"onMouseMoveColumnHeader","mouseleave th":"onMouseLeaveColumnHeader","dragstart th":"onStartDragColumnHeader",dragend:"onEndDragColumnHeader","dragenter th div":"onDragEnterColumnHeader","dragover th div":"onDragOverColumnHeader","dragleave th div":"onDragLeaveColumnHeader","drop th div":"onDropColumnHeader","blur td div":"onCellValueChanged"},render:function(t){"function"==typeof t&&(this.renderCallback=_.once(t));var e={};if(!this.rows.init)return this.rows.bind("reset",this.render,this),this.rows.bind("sort",this.render,this),this.dataWorker?this.dataWorker.postMessage(null):this.dataFunction(this),this;if(this.renderTable===!0){this.renderTable=!1,e.columns=this.columns.toJSON(),e.rows=h(this.rows),e.visibleCount=this.rows.visibleCount,this.tbodyElt&&(this.prevScrollTop=this.tbodyElt[0].scrollTop),this.generateTableHtml(e);for(var i=this.tableElt.find("th"),r=0;i.length>r;r++)this.columns.at(r).set("element",$(i[r]));this.tbodyElt[0].scrollTop=this.prevScrollTop,$("tbody:not(.scrollBound)").addClass("scrollBound").bind("scroll",this.onTableScrolled),this.sizeTable(),"number"==typeof this.rows.sortColumn&&this.displaySortArrow(this.columns.at(this.rows.sortColumn).get("name"),this.rows.sortDescending),"function"==typeof this.renderCallback&&this.renderCallback()}else this.renderRows(this.prevScrollTop,this.tbodyElt[0].scrollTop);return this},renderRows:function(e,i){var r,s,o=this.rowRange.last-this.rowRange.first-(this.rowRange.prevLast-this.rowRange.prevFirst),n=this.visibleRows+g;if(e>i)r=this.rowRange.first,s=this.rowRange.prevFirst,this.rowRange.last<=this.rowRange.prevFirst&&(r=this.rowRange.first,s=this.rowRange.last),this.removeRows(s-r-o,!1),this.addRows(r,s,!0),t(this.tbodyElt[0],this.rows,this.rowHeight,this.rowRange.first);else if(i>e)r=this.rowRange.prevLast,s=this.rowRange.last,this.rowRange.first>=this.rowRange.prevLast&&(r=this.rowRange.first,s=this.rowRange.last),this.removeRows(s-r-o,!0),this.addRows(r,s,!1),t(this.tbodyElt[0],this.rows,this.rowHeight,this.rowRange.first);else{if(!this.dataAppended)return this.refreshRows(this.rowRange.first),void 0;this.dataAppended=!1,this.rowRange.last<this.rows.visibleCount&&n>this.rowRange.last&&(r=this.rowRange.last,s=this.rows.visibleCount,s>n&&(s=n),this.addRows(r,s,!1),this.rowRange.last=s),t(this.tbodyElt[0],this.rows,this.rowHeight,this.rowRange.first),this.resizeIndicator.style.height=this.tableElt.height()+1+"px"}if(this.scrollbarWidth=d(this.tbodyElt[0]),this.scrollbarWidth>0){var l=this.tableElt.find("th"),a=this.columns.get(l[l.length-1].getAttribute("data-column")).get("width");this.resizeColumnElements(l.length-1,a)}this.prevScrollTop=this.tbodyElt[0].scrollTop},addRows:function(t,e,i){for(var r=this.tbodyElt[0].firstChild,s=this.tbodyElt[0].lastChild,o=i?r.nextElementSibling:s,n=t;e>n;n++)this.addRow(n,o)},addRow:function(t,e){var i=document.createElement("tr");i.setAttribute("data-row",t);for(var r=0;this.columns.length>r;r++){var s=this.columns.at(r);if(s.get("visible")){var o=document.createElement("div");s.get("cellClasses")&&o.setAttribute("class",s.get("cellClasses"));var n=s.get("width");o.style.width=n+"px",o.innerHTML=this.formatter(this.rows.getValue(t,r),t,r,s.get("name"));var l=document.createElement("td");l.appendChild(o),i.appendChild(l)}}this.tbodyElt[0].insertBefore(i,e)},removeRows:function(t,e){var i,r;if(t>this.visibleRows+2*g&&(t=this.visibleRows+2*g),e)i=2,r=t+2;else{var s=this.tbodyElt[0].childElementCount-2;i=s+2-t,r=s+2}for(var o=i;r>o;o++)this.tableElt[0].deleteRow(i)},refreshRows:function(t){for(var e=this.tbodyElt[0].getElementsByTagName("tr"),i=1;e.length-1>i;i++){var r=e[i];r.setAttribute("data-row",t+i-1);for(var s=$(r).find("td").children("div"),o=0;s.length>o;o++){var n=s[o];n.innerHTML=this.formatter(this.rows.getValue(t+i-1,o),t+i-1,o,this.columns.at(o).get("name"))}}},sizeTable:function(){for(var t=this.tableElt.find("th"),e=0,i=0;t.length>i;i++)e+=$(t[i])[0].offsetWidth;this.tableElt.width(e),this.parentElt.width(e)},filter:function(t,e,i){var r=this.columns.get(t);if(!r)throw"Invalid column name";this.rows.filter(r.get("order"),e,i)&&(this.renderTable=!0,this.render(),this.trigger("filter",t,e,i))},renameColumn:function(t,e){this.columns.renameColumn(t,e)},moveColumn:function(t,e){var i,r;if("string"==typeof t?i=this.columns.get(t):"number"==typeof t&&(i=this.getColumnByPosition(t)),"string"==typeof e?r=this.columns.get(e):"number"==typeof e&&(r=this.getColumnByPosition(e)),!i)throw"Invalid source column: "+t;if(!r)throw"Invalid dest column: "+e;if(t!==e){var s=i.get("order"),o=r.get("order");this.renderTable=!0,this.renderCallback=function(){this.trigger("moveColumn",i.get("name"),s,o)},this.rows.moveColumn(i.get("order"),r.get("order")),this.columns.moveColumn(i.get("order"),r.get("order"))}},resizeColumn:function(t,e){var i=this.columns.get(t);if(!i)throw"Invalid column name: "+t;v>e&&(e=v);var r=i.get("width");i.set("width",e),this.resizeColumnElements(i.get("element")[0].cellIndex,e),this.trigger("resizeColumn",i.get("name"),r,e)},sort:function(t,e){var i=this.columns.get(t);if(!i)throw"Invalid column name: "+t;this.rows.setSortColumn(i.get("order")),"boolean"==typeof e&&(this.rows.sortDescending=e),this.displaySortArrow(t,this.rows.sortDescending),this.rows.sort(),this.trigger("sort",i.get("name"),this.rows.sortDescending)},showColumn:function(t){var e=this.columns.get(t);if(!e)throw"Invalid column name: "+t;e.get("visible")!==!0&&(this.renderTable=!0,this.renderCallback=function(){this.trigger("showColumn",t)},e.set({visible:!0}),this.renderTable=!1)},hideColumn:function(t){var e=this.columns.get(t);if(!e)throw"Invalid column name: "+t;e.get("visible")&&(this.renderTable=!0,this.renderCallback=function(){this.trigger("hideColumn",t)},e.set({visible:!1}),this.renderTable=!1)},getColumnByPosition:function(t){var e=this.tableElt.find("th");return 0>t||t>e.length?null:this.columns.get(e[t].getAttribute("data-column"))},onTableScrolled:function(t){if(this.prevScrollTop!==t.target.scrollTop){var e=parseInt(t.target.scrollTop/this.rowHeight,10),i=e-g;0>i&&(i=0),this.rowRange.prevFirst=this.rowRange.first,this.rowRange.prevLast=this.rowRange.last,this.rowRange.first=i,this.rowRange.last=e+this.visibleRows+g,this.rowRange.last>this.rows.visibleCount&&(this.rowRange.last=this.rows.visibleCount,this.rowRange.first=Math.max(0,this.rowRange.last-this.visibleRows-g)),this.renderRows(this.prevScrollTop,t.target.scrollTop)}},onMouseMoveColumnHeader:function(t){var e=o(t),i=$(t.target).closest("th")[0];i.style.cursor=e&&this.columns.get(e).get("resizable")?"e-resize":null},onMouseLeaveColumnHeader:function(t){var e=$(t.target).closest("th")[0];e.style.cursor=null},onClickColumnHeader:function(t){if(!o(t)){var e=$(t.target).closest("th")[0];this.columns.get(e.getAttribute("data-column")).get("sortable")&&this.sort(e.getAttribute("data-column"))}},onStartDragColumnHeader:function(t){var e=$(t.target),i=o(t);if(i){var r=this.columns.get(i);if(e=r.get("element"),!r.get("resizable"))return t.preventDefault&&t.preventDefault(),!1;var s,n,l=e.offset(),a=this.tableElt.parent().offset(),h=this.tableElt.height()+1,d=e.css("padding-left"),u=e.css("padding-right");l.left<a.left?(s=a.left,n=a.left-l.left):(s=l.left,n=0);var c=e.width()-n+Number(d.substring(0,d.length-2))+Number(u.substring(0,u.length-2))-5;$(this.resizeIndicator).css("display","block").css("left",s).css("top",l.top-1).css("height",h).css("width",c).attr("data-column",e[0].getAttribute("data-column")),document.addEventListener("mousemove",this.onDragResizeIndicator,!1),document.addEventListener("mouseup",this.onEndDragColumnHeader,!1),t.preventDefault()}else this.movableColumns?(t.target.style.opacity=.35,t.originalEvent.dataTransfer.setData("text",this.atableId+"."+e[0].getAttribute("data-column"))):t.preventDefault()},onDragResizeIndicator:function(t){var e=$(this.resizeIndicator).offset();this.columns.get(this.resizeIndicator.getAttribute("data-column"));var i=t.pageX-e.left;v>i&&(i=v),this.resizeIndicator.style.width=i+"px"},onEndDragColumnHeader:function(t){if("none"===$(this.resizeIndicator).css("display"))t.target.style.opacity=null;else{document.removeEventListener("mousemove",this.onDragResizeIndicator,!1),document.removeEventListener("mouseup",this.onDragResizeIndicator,!1);var e=this.resizeIndicator,i=parseInt(t.clientX-$(e).position().left,10),r=e.scrollWidth,s=this.columns.get(e.getAttribute("data-column")),o=s.get("element").offset(),n=this.tableElt.parent().offset();o.left<n.left&&(r+=n.left-o.left),i=r>i?r:i,e.style.display="none",this.resizeColumn(s.get("name"),i)}},onDragEnterColumnHeader:function(t){var e=t.originalEvent.dataTransfer.getData("text"),i=$(t.target).closest("th")[0];i.getAttribute("data-column")!==e&&$(i.firstChild).addClass("over")},onDragOverColumnHeader:function(t){t.preventDefault&&t.preventDefault()},onDragLeaveColumnHeader:function(t){$(t.target).removeClass("over")},onDropColumnHeader:function(t){t.preventDefault&&t.preventDefault();var e=t.originalEvent.dataTransfer.getData("text"),i=e.split(".");if(this.movableColumns&&i[0]==this.atableId){var r=i[1],s=t.target.parentNode.getAttribute("data-column");"TH"===t.target.tagName&&(s=t.target.getAttribute("data-column")),this.moveColumn(r,s)}"TH"===t.target.tagName?$(t.target.firstChild).removeClass("over"):$(t.target).removeClass("over")},onCellValueChanged:function(t){var e=t.target.getAttribute("data-origVal"),i=t.target.innerHTML;if(e!==i){t.target.setAttribute("data-origVal",i);var r=t.target.parentNode.parentNode.getAttribute("data-row"),s=this.getColumnByPosition(t.target.parentNode.cellIndex);this.rows.setValue(parseInt(r,10),s.get("order"),i),this.trigger("edit",r,s.get("order"),e,i)}},displaySortArrow:function(t,e){var i=this.tableElt.find(".sortArrow");if(i.length){i=i[0];var r=i.parentNode.scrollWidth;this.resizeColumnElements(i.parentNode.parentNode.cellIndex,r-i.scrollWidth),i.parentNode.removeChild(i)}else i=document.createElement("div"),i.className="sortArrow";i.innerHTML=e?"&darr;":"&uarr;";var s=this.columns.get(t).get("element")[0];s.firstChild.insertBefore(i,s.firstChild.firstChild),this.resizeColumnElements(s.cellIndex,s.firstChild.scrollWidth+i.scrollWidth)},resizeColumnElements:function(t,e){var i=this.tableElt.find("th");i[t].firstChild.style.width=e+"px";var r=this.columns.get(i[t].getAttribute("data-column"));r.set({width:e}),t===i.length-1&&(e-=this.scrollbarWidth),this.tbodyElt.find("td:nth-child("+(t+1)+")>div").each(function(){this.style.width=e+"px"}),this.sizeTable()},generateTableHtml:function(t){var e,i=0;if(this.tbodyElt){var r=this.tbodyElt[0].firstChild.style.height;i=r.substr(0,r.length-2)}for(var o="<tr>",n=0;t.columns.length>n;n++)if(t.columns[n].visible){e=t.columns[n];var l="",a="";l='style="width: '+t.columns[n].width+'px;"',t.columns[n].sortable&&(a=' class="sortable"'),o+='<th draggable="true" '+a+' data-column="'+t.columns[n].name+'"><div '+l+">"+t.columns[n].label+"</div></th>"}o+="</tr>";var h=document.createDocumentFragment(),u=document.createElement("div");u.className="atableParent";var c=document.createElement("table");c.className="atable",u.appendChild(c);var m=document.createElement("thead");c.appendChild(m);var f=document.createElement("tbody");if(f.style.maxHeight=this.height+"px",c.appendChild(f),h.appendChild(u),this.resizeIndicator||(s(this),h.appendChild(this.resizeIndicator)),this.parentElt&&this.el.removeChild(this.parentElt[0]),this.el.appendChild(h),this.tableElt=$(c),this.parentElt=$(u),this.tbodyElt=$(f),!this.rowHeight){var v=document.createElement("tr");v.innerHTML="<td>0</td>",v.style.visibility="hidden",v.style.position="absolute",f.appendChild(v),this.rowHeight=$(v).outerHeight(),f.removeChild(v),this.visibleRows=parseInt(this.height/this.rowHeight,10)}if(!this.rowRange){var b=this.visibleRows+g;b>t.visibleCount&&(b=t.visibleCount),this.rowRange={first:0,last:b,prevFirst:0,prevLast:b}}for(var w="<tr style='height: "+i+"px;'></tr>",p=0,C=this.rowRange.first;t.rows.length>C&&this.rowRange.last>p;C++)if(t.rows[C].visible){w+='<tr data-row="'+C+'">';for(var y=0;t.rows[C].row.length>y;y++)if(t.columns[y].visible){var R=t.columns[y].width,E=t.columns[y].editable?"contenteditable='true' ":"",T="";t.columns[y].cellClasses&&(T=" class='"+t.columns[y].cellClasses+"'");var z=this.formatter(t.rows[C].row[y],C,y,t.columns[y].name);w+="<td"+T+'><div data-origVal="'+z+'" '+E+'style="width: '+R+'px;">'+z+"</div></td>"}w+="</tr>",p++}if(w+="<tr style='height: "+(this.rowHeight*(t.visibleCount-this.visibleRows-g)-i)+"px;'></tr>",$(m).html(o),$(f).html(w),this.scrollbarWidth=d(f),this.scrollbarWidth>0){var D=e.width;$(f).find("td:last-child>div").width(D-this.scrollbarWidth)}},receivedData:function(t,i){this.scrollTop=this.$el.find(".table").scrollTop(),this.rows.init||(this.rows.init=!0);for(var r=[],s=0;t.length>s;s++)r.push(new e({row:t[s]}));i?(this.dataAppended=!0,this.rows.add(r),this.render()):this.rows.reset(r)},close:function(){this.resizeIndicator&&document.removeChild(this.resizeIndicator),this.remove(),this.unbind()}})}();return s}();