/*!
 * aTable v0.2.0
 * Copyright (c) 2012-2013 Jared Wolinsky
 * Licensed under the MIT License - http://opensource.org/licenses/MIT
 */
var Column=Backbone.Model.extend({initialize:function(){},idAttribute:"name"}),Row=Backbone.Model.extend({initialize:function(){},defaults:{row:[]}}),ColumnCollection=Backbone.Collection.extend({initialize:function(){},model:Column,comparator:function(t){return t.get("order")},renameColumn:function(t,e){if(!e)throw"Invalid column name";var i=this.get(t);i&&i.set({name:e})},moveColumn:function(t,e){var i=this.at(t),r=this.at(e);if(!i)throw"Invalid column index: "+t;if(!r)throw"Invalid column index: "+e;var s,n=i.get("order"),o=r.get("order");if(o>n)for(var l=n+1;o>=l;l++)s=this.at(l),s.set({order:s.get("order")-1});else for(var a=n-1;a>=o;a--)s=this.at(a),s.set({order:s.get("order")+1});i.set({order:o}),this.sort()}}),RowCollection=function(){function t(t,e,i){var r=t[e];t[e]=t[i],t[i]=r}return Backbone.Collection.extend({initialize:function(t,e){this.init=!1,this.columnOrder=[],e?(this.sortColumn=e.sortColumn,this.sortDescending=null!==e.sortDescending?e.sortDescending:!1):(this.sortColumn=null,this.sortDescending=!1);for(var i=0;e.numColumns>i;i++)this.columnOrder.push(i)},model:Row,getValue:function(t,e){var i=this.at(t).get("row"),r=this.columnOrder[e];return i[r]},getRow:function(t){for(var e=this.at(t).get("row"),i=[],r=0;e.length>r;r++){var s=this.columnOrder[r];i.push(e[s])}return i},getColumnIndex:function(t){return this.columnOrder[t]},moveColumn:function(e,i){if(i>e){this.sortColumn>e&&i>=this.sortColumn?this.sortColumn--:this.sortColumn===e&&(this.sortColumn=i);for(var r=e;i>r;r++)t(this.columnOrder,r,r+1)}else{e>this.sortColumn&&this.sortColumn>=i?this.sortColumn++:this.sortColumn===e&&(this.sortColumn=i);for(var s=e;s>i;s--)t(this.columnOrder,s,s-1)}},setSortColumn:function(t){this.sortColumn===t?this.sortDescending=!this.sortDescending:this.sortColumn=t},comparator:function(t){var e=t.get("row")[this.columnOrder[this.sortColumn]],i=null;if("number"==typeof e)i=e;else if("object"==typeof e)i=e instanceof Date?e.getTime():0;else if("string"==typeof e)return this.sortDescending?(e=e.toLowerCase(),e=e.split(""),e=_.map(e,function(t){return String.fromCharCode(-t.charCodeAt(0))}),e.join("")):e;return this.sortDescending?-i:i}})}(),ATable=function(){function t(t,e,i,r){var s=t.childElementCount-2,n=(e.length-s)*i;if(0>n)t.firstChild.style.height=0,t.lastChild.style.height=0;else{var o=r*i,l=n-o;t.firstChild.style.height=o+"px",t.lastChild.style.height=l+"px"}}function e(){var t=0;$(".resizeIndicator").each(function(){t=parseInt(this.id.split("resize")[1],10)+1});var e=document.createElement("div");return e.className="resizeIndicator",e.id="resize"+t,e}function i(t){var e=t.offsetX,i=!t.target.previousElementSibling,r=$(t.target).closest("th")[0];return e===void 0&&(e=t.originalEvent.pageX-$(t.target).offset().left),!i&&u+1>=e?r.previousElementSibling.getAttribute("data-column"):u>=t.target.offsetWidth-e?r.getAttribute("data-column"):null}function r(t){return null!==t.columns&&0===t.columns.length?"Columns array missing or empty":t.dataFunction?null:"Missing dataFunction arg: actual function or script tag id with data function"}function s(t,e){if(window.Blob&&window.Worker){var i=new Blob([document.querySelector("#"+t).textContent," self.onmessage=function(){"+t+"();};"]),r=window.URL||window.webkitURL,s=new Worker(r.createObjectURL(i));return s.onmessage=function(t){e(t.data.data,t.data.append)},s}throw"Blob and Worker support required to use the web worker interface."}function n(t){for(var e=t.columns,i=0;e.length>i;i++)e[i].width===void 0&&(e[i].width=a(e[i].label)+20),e[i].resizable===void 0&&(e[i].resizable=t.resizableColumns),e[i].sortable===void 0&&(e[i].sortable=t.sortable),e[i].label===void 0&&(e[i].label=e[i].name),e[i].visible===void 0&&(e[i].visible=!0),e[i].order=i;return new ColumnCollection(e)}function o(t){for(var e=[],i=0;t.length>i;i++)e.push({row:t.getRow(i)});return e}function l(t){return t?t.offsetWidth-t.clientWidth:0}function a(t){var e=$("<th>"+t+"</th>").css({position:"absolute","float":"left","white-space":"nowrap",visibility:"hidden"}).appendTo($("body")),i=e.width();return e.remove(),i}function h(t){t.resizableColumns===void 0&&(t.resizableColumns=!0),t.movableColumns===void 0&&(t.movableColumns=!0),t.sortable===void 0&&(t.sortable=!0)}var d=5,u=7,c=20;return Backbone.View.extend({initialize:function(t){_.bindAll(this),"string"==typeof t.dataFunction?this.dataWorker=s(t.dataFunction,this.receivedData):"function"==typeof t.dataFunction&&(this.dataFunction=t.dataFunction),this.renderTable=!0,this.dataAppended=!1;var e=r(t);if(e)throw e;if(h(t),this.columns=n(t),this.columns.bind("reset",this.render,this),this.columns.bind("sort",this.render,this),this.columns.bind("change:visible",this.render,this),this.movableColumns=t.movableColumns,"string"==typeof t.sortColumn){var i=this.columns.indexOf(t.sortColumn);t.sortColumn=i>0?i:0}t.numColumns=this.columns.length,this.rows=new RowCollection([],t),this.height=t.height,this.prevScrollTop=0},events:{"click th":"onClickColumnHeader","mousemove th":"onMouseMoveColumnHeader","mouseleave th":"onMouseLeaveColumnHeader","dragstart th":"onStartDragColumnHeader",dragend:"onEndDragColumnHeader","dragenter th div":"onDragEnterColumnHeader","dragover th div":"onDragOverColumnHeader","dragleave th div":"onDragLeaveColumnHeader","drop th div":"onDropColumnHeader"},render:function(t){"function"==typeof t&&(this.renderCallback=t);var e={};if(!this.rows.init)return this.rows.bind("reset",this.render,this),this.rows.bind("sort",this.render,this),this.dataWorker?this.dataWorker.postMessage(null):this.dataFunction(this),this;if(this.renderTable===!0){this.renderTable=!1,e.columns=this.columns.toJSON(),e.rows=o(this.rows),this.tbodyElt&&(this.prevScrollTop=this.tbodyElt[0].scrollTop),this.generateTableHtml(e);for(var i=this.tableElt.find("th"),r=0;i.length>r;r++)this.columns.at(r).set("element",$(i[r]));if(this.tbodyElt[0].scrollTop=this.prevScrollTop,$("tbody:not(.scrollBound)").addClass("scrollBound").bind("scroll",this.onTableScrolled),this.sizeTable(),"number"==typeof this.rows.sortColumn&&this.displaySortArrow(this.columns.at(this.rows.sortColumn).get("name"),this.rows.sortDescending),"function"==typeof this.renderCallback){var s=this.renderCallback;this.renderCallback=null,s()}}else this.renderRows(this.prevScrollTop,this.tbodyElt[0].scrollTop);return this},renderRows:function(e,i){var r,s,n=this.rowRange.last-this.rowRange.first-(this.rowRange.prevLast-this.rowRange.prevFirst),o=this.visibleRows+d;if(e>i)r=this.rowRange.first,s=this.rowRange.prevFirst,this.rowRange.last<=this.rowRange.prevFirst&&(r=this.rowRange.first,s=this.rowRange.last),this.removeRows(s-r-n,!1),this.addRows(r,s,!0),t(this.tbodyElt[0],this.rows,this.rowHeight,this.rowRange.first);else if(i>e)r=this.rowRange.prevLast,s=this.rowRange.last,this.rowRange.first>=this.rowRange.prevLast&&(r=this.rowRange.first,s=this.rowRange.last),this.removeRows(s-r-n,!0),this.addRows(r,s,!1),t(this.tbodyElt[0],this.rows,this.rowHeight,this.rowRange.first);else{if(!this.dataAppended)return this.refreshRows(this.rowRange.first),void 0;this.dataAppended=!1,this.rowRange.last<this.rows.length&&o>this.rowRange.last&&(r=this.rowRange.last,s=this.rows.length,s>o&&(s=o),this.addRows(r,s,!1),this.rowRange.last=s),t(this.tbodyElt[0],this.rows,this.rowHeight,this.rowRange.first),this.resizeIndicator.style.height=this.tableElt.height()+1+"px"}if(this.scrollbarWidth=l(this.tbodyElt[0]),this.scrollbarWidth>0){var a=this.tableElt.find("th"),h=this.columns.get(a[a.length-1].getAttribute("data-column")).get("width");this.resizeColumnElements(a.length-1,h)}this.prevScrollTop=this.tbodyElt[0].scrollTop},addRows:function(t,e,i){for(var r=this.tbodyElt[0].firstChild,s=this.tbodyElt[0].lastChild,n=i?r.nextElementSibling:s,o=t;e>o;o++)this.addRow(o,n)},addRow:function(t,e){var i,r=document.createElement("tr"),s=this.tableElt.find(".sortArrow"),n=null;s.length&&(n=s[0].parentElement.parentElement.getAttribute("data-column"),i=s[0].scrollWidth);for(var o=0;this.columns.length>o;o++){var l=this.columns.at(o);if(l.get("visible")){var a=document.createElement("div"),h=l.get("width");a.style.width=h+"px",a.innerHTML=this.rows.getValue(t,o);var d=document.createElement("td");d.appendChild(a),r.appendChild(d)}}this.tbodyElt[0].insertBefore(r,e)},removeRows:function(t,e){var i,r;if(t>this.visibleRows+2*d&&(t=this.visibleRows+2*d),e)i=2,r=t+2;else{var s=this.tbodyElt[0].childElementCount-2;i=s+2-t,r=s+2}for(var n=i;r>n;n++)this.tableElt[0].deleteRow(i)},refreshRows:function(t){var e=this.tbodyElt[0].getElementsByTagName("tr");e.length-2,e=this.tbodyElt[0].getElementsByTagName("tr");for(var i=1;e.length-1>i;i++)for(var r=e[i],s=r.getElementsByTagName("div"),n=0;s.length>n;n++){var o=s[n];o.innerHTML=this.rows.getValue(t+i-1,n)}},sizeTable:function(){for(var t=this.tableElt.find("th"),e=0,i=0;t.length>i;i++)e+=$(t[i])[0].offsetWidth;this.tableElt.width(e),this.parentElt.width(e)},filter:function(){},renameColumn:function(t,e){this.columns.renameColumn(t,e)},moveColumn:function(t,e){var i,r;if("string"==typeof t?i=this.columns.get(t):"number"==typeof t&&(i=this.getColumnByPosition(t)),"string"==typeof e?r=this.columns.get(e):"number"==typeof e&&(r=this.getColumnByPosition(e)),!i)throw"Invalid source column: "+t;if(!r)throw"Invalid dest column: "+e;t!==e&&(this.renderTable=!0,this.rows.moveColumn(i.get("order"),r.get("order")),this.columns.moveColumn(i.get("order"),r.get("order")))},resizeColumn:function(t,e){var i=this.columns.get(t);if(!i)throw"Invalid column name: "+t;c>e&&(e=c),i.set("width",e),this.resizeColumnElements(i.get("element")[0].cellIndex,e)},sort:function(t,e){var i=this.columns.get(t);if(!i)throw"Invalid column name: "+t;this.rows.setSortColumn(i.get("order")),"boolean"==typeof e&&(this.rows.sortDescending=e),this.displaySortArrow(t,this.rows.sortDescending),this.rows.sort()},showColumn:function(t){var e=this.columns.get(t);if(!e)throw"Invalid column name: "+t;this.renderTable=!0,e.set({visible:!0}),this.renderTable=!1},hideColumn:function(t){var e=this.columns.get(t);if(!e)throw"Invalid column name: "+t;this.renderTable=!0,e.set({visible:!1}),this.renderTable=!1},getColumnByPosition:function(t){var e=this.tableElt.find("th");return 0>t||t>e.length?null:this.columns.get(e[t].getAttribute("data-column"))},onTableScrolled:function(t){if(this.prevScrollTop!==t.target.scrollTop){var e=parseInt(t.target.scrollTop/this.rowHeight,10),i=e-d;0>i&&(i=0),this.rowRange.prevFirst=this.rowRange.first,this.rowRange.prevLast=this.rowRange.last,this.rowRange.first=i,this.rowRange.last=e+this.visibleRows+d,this.rowRange.last>this.rows.length&&(this.rowRange.last=this.rows.length,this.rowRange.first=this.rowRange.last-this.visibleRows-d),this.renderRows(this.prevScrollTop,t.target.scrollTop)}},onMouseMoveColumnHeader:function(t){var e=i(t),r=$(t.target).closest("th")[0];r.style.cursor=e&&this.columns.get(e).get("resizable")?"e-resize":null},onMouseLeaveColumnHeader:function(t){var e=$(t.target).closest("th")[0];e.style.cursor=null},onClickColumnHeader:function(t){if(!i(t)){var e=$(t.target).closest("th")[0];this.columns.get(e.getAttribute("data-column")).get("sortable")&&this.sort(e.getAttribute("data-column"))}},onStartDragColumnHeader:function(t){var e=$(t.target),r=i(t);if(r){var s=this.columns.get(r);if(e=s.get("element"),!s.get("resizable"))return t.preventDefault&&t.preventDefault(),!1;var n,o,l=e.offset(),a=this.tableElt.parent().offset(),h=this.tableElt.height()+1,d=e.css("padding-left"),u=e.css("padding-right");l.left<a.left?(n=a.left,o=a.left-l.left):(n=l.left,o=0);var c=e.width()-o+Number(d.substring(0,d.length-2))+Number(u.substring(0,u.length-2))-5;$(this.resizeIndicator).css("display","block").css("left",n).css("top",l.top-1).css("height",h).css("width",c).attr("data-column",e[0].getAttribute("data-column")),document.addEventListener("dragover",this.onDragResizeIndicator),t.originalEvent.dataTransfer.setDragImage(document.createElement("div"),0,0),t.originalEvent.dataTransfer.setData("text",e[0].getAttribute("data-column"))}else this.movableColumns?(t.target.style.opacity=.35,t.originalEvent.dataTransfer.setData("text",e[0].getAttribute("data-column"))):t.preventDefault()},onDragResizeIndicator:function(t){var e=$(this.resizeIndicator).offset(),i=this.columns.get(t.dataTransfer.getData("text"));i.get("element");var r=t.pageX-e.left;c>r&&(r=c),$(this.resizeIndicator).css("width",r)},onEndDragColumnHeader:function(t){if("none"===$(this.resizeIndicator).css("display"))t.target.style.opacity=null;else{document.removeEventListener("dragover",this.onDragResizeIndicator,!1);var e=this.resizeIndicator,i=parseInt(t.originalEvent.clientX-$(e).position().left,10),r=e.scrollWidth,s=this.columns.get(e.getAttribute("data-column")),n=s.get("element").offset(),o=this.tableElt.parent().offset();n.left<o.left&&(r+=o.left-n.left),i=r>i?r:i,e.style.display="none",this.resizeColumn(s.get("name"),i)}},onDragEnterColumnHeader:function(t){var e=t.originalEvent.dataTransfer.getData("text");if(this.movableColumns&&"none"===$(this.resizeIndicator).css("display")){var i=$(t.target).closest("th")[0];i.getAttribute("data-column")!==e&&i.firstChild.classList.add("over")}},onDragOverColumnHeader:function(t){t.preventDefault&&t.preventDefault()},onDragLeaveColumnHeader:function(t){t.target.classList.remove("over")},onDropColumnHeader:function(t){if(t.preventDefault&&t.preventDefault(),this.movableColumns&&"none"===$(this.resizeIndicator).css("display")){var e=t.originalEvent.dataTransfer.getData("text"),i=t.target.parentElement.getAttribute("data-column");"TH"===t.target.tagName?(i=t.target.getAttribute("data-column"),t.target.firstChild.classList.remove("over")):t.target.classList.remove("over"),this.moveColumn(e,i)}},displaySortArrow:function(t,e){var i=this.tableElt.find(".sortArrow");if(i.length){i=i[0];var r=i.parentElement.scrollWidth;this.resizeColumnElements(i.parentElement.parentElement.cellIndex,r-i.scrollWidth),i.parentElement.removeChild(i)}else i=document.createElement("div"),i.className="sortArrow";i.innerHTML=e?"&darr;":"&uarr;";var s=this.columns.get(t).get("element")[0];s.firstChild.insertBefore(i,s.firstChild.firstChild),this.resizeColumnElements(s.cellIndex,s.firstChild.scrollWidth+i.scrollWidth)},resizeColumnElements:function(t,e){var i=this.tableElt.find("th");i[t].firstChild.style.width=e+"px";var r=this.columns.get(i[t].getAttribute("data-column"));r.set({width:e}),t===i.length-1&&(e-=this.scrollbarWidth),this.tbodyElt.find("td:nth-child("+(t+1)+")>div").each(function(){this.style.width=e+"px"}),this.sizeTable()},generateTableHtml:function(t){var i,r=0;if(this.tbodyElt){var s=this.tbodyElt[0].firstChild.style.height;r=s.substr(0,s.length-2)}for(var n="<tr>",o=0;t.columns.length>o;o++)if(t.columns[o].visible){i=t.columns[o];var a="",h="";a='style="width: '+t.columns[o].width+'px;"',t.columns[o].sortable&&(h=' class="sortable"'),n+='<th draggable="true" '+h+' data-column="'+t.columns[o].name+'"><div '+a+">"+t.columns[o].label+"</div></th>"}n+="</tr>";var u=document.createDocumentFragment(),c=document.createElement("div");c.className="atableParent";var m=document.createElement("table");m.className="atable",c.appendChild(m);var g=document.createElement("thead");m.appendChild(g);var f=document.createElement("tbody");if(f.style.maxHeight=this.height+"px",m.appendChild(f),u.appendChild(c),this.resizeIndicator||(this.resizeIndicator=e(),u.appendChild(this.resizeIndicator)),this.parentElt&&this.el.removeChild(this.parentElt[0]),this.el.appendChild(u),this.tableElt=$(m),this.parentElt=$(c),this.tbodyElt=$(f),!this.rowHeight){var v=document.createElement("tr");v.innerHTML="<td>0</td>",v.style.visibility="hidden",v.style.position="absolute",f.appendChild(v),this.rowHeight=$(v).outerHeight(),f.removeChild(v),this.visibleRows=parseInt(this.height/this.rowHeight,10)}if(!this.rowRange){var w=this.visibleRows+d;w>t.rows.length&&(w=t.rows.length),this.rowRange={first:0,last:w,prevFirst:0,prevLast:w}}for(var b="<tr style='height: "+r+"px;'></tr>",p=this.rowRange.first;t.rows.length>p&&this.rowRange.last>p;p++){b+="<tr>";for(var C=0;t.rows[p].row.length>C;C++)if(t.columns[C].visible){var E=t.columns[C].width;b+='<td><div style="width: '+E+'px;">'+t.rows[p].row[C]+"</div></td>"}b+="</tr>"}if(b+="<tr style='height: "+(this.rowHeight*(t.rows.length-this.visibleRows-d)-r)+"px;'></tr>",$(g).html(n),$(f).html(b),this.scrollbarWidth=l(f),this.scrollbarWidth>0){var y=i.width;$(f).find("td:last-child>div").width(y-this.scrollbarWidth)}},receivedData:function(t,e){this.scrollTop=this.$el.find(".table").scrollTop(),this.rows.init||(this.rows.init=!0);for(var i=[],r=0;t.length>r;r++)i.push(new Row({row:t[r]}));e?(this.dataAppended=!0,this.rows.add(i),this.rows.trigger("reset")):this.rows.reset(i)},close:function(){this.resizeIndicator&&document.removeChild(this.resizeIndicator),this.remove(),this.unbind()}})}();